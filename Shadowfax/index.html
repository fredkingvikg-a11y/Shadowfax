<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Shadowfax</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
[data-theme=dark]{--bg:#0a0a0a;--bg3:#171717;--bg4:#222;--bd:#252525;--bd2:#333;--t:#f5f5f5;--t2:#aaa;--t3:#555;--nav:rgba(10,10,10,.97);--inp:#171717}
[data-theme=light]{--bg:#f2f2f7;--bg3:#fff;--bg4:#f0f0f0;--bd:#e5e5ea;--bd2:#d1d1d6;--t:#0a0a0a;--t2:#555;--t3:#999;--nav:rgba(242,242,247,.97);--inp:#fff}
:root{--g:#00c853;--r:#ff3d57;--go:#f5c842;--b:#38c8ff;--p:#b44dff;
--gd:rgba(0,200,83,.13);--rd:rgba(255,61,87,.13);--god:rgba(245,200,66,.13);--bd3:rgba(56,200,255,.13);--ra:14px;--rs:8px}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden;transition:background .2s,color .2s}
.screen{display:none;flex-direction:column;min-height:100vh;padding-bottom:84px}
.screen.active{display:flex}
.tb{display:flex;align-items:center;justify-content:space-between;padding:54px 20px 14px;position:sticky;top:0;background:var(--bg);z-index:20;border-bottom:1px solid var(--bd)}
.lw{display:flex;align-items:center;gap:9px}
.lw h1{font-family:'Times New Roman',Times,serif;font-size:23px;font-weight:700}
.lw h1 .fx{color:var(--b)}
.ibtn{width:36px;height:36px;border-radius:50%;background:var(--bg3);border:1px solid var(--bd2);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.av{width:36px;height:36px;border-radius:50%;background:var(--b);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;font-weight:700;color:#000}
.scr{flex:1;overflow-y:auto;padding:0 20px 20px}.scr::-webkit-scrollbar{display:none}
.sec{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin:22px 0 11px}
.up{color:var(--g)}.dn{color:var(--r)}
.dv{height:1px;background:var(--bd);margin:18px 0}
.card{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);padding:16px;margin-bottom:11px}
.card h4{font-size:13px;font-weight:700;margin-bottom:13px}
.hs{display:flex;gap:9px;overflow-x:auto;padding:0 20px 4px;margin:0 -20px}.hs::-webkit-scrollbar{display:none}
.mc{min-width:110px;background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:11px 13px;flex-shrink:0}
.mc-l{font-size:9px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px}
.mc-v{font-size:17px;font-weight:700;letter-spacing:-.5px}
.mc-c{font-size:11px;font-weight:500;margin-top:2px}
.sbar{background:linear-gradient(90deg,var(--r) 0%,#ff9800 33%,var(--go) 50%,#8bc34a 67%,var(--g) 100%);height:5px;border-radius:3px;position:relative;margin:12px 0 8px}
.sneedle{position:absolute;top:-5px;width:14px;height:14px;background:var(--t);border-radius:50%;transform:translateX(-50%);border:2px solid var(--bg);box-shadow:0 0 6px rgba(0,200,83,.5);transition:left .6s}
.slabs{display:flex;justify-content:space-between;font-size:9px;color:var(--t3);font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.badge{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700}
.wli{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-bottom:1px solid var(--bd)}
.wli:last-child{border-bottom:none}
.wlic{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;flex-shrink:0}
.sp{width:58px;height:26px}
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:var(--nav);border-top:1px solid var(--bd);display:flex;justify-content:space-around;align-items:center;padding:10px 0 26px;z-index:100;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}
.nb{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:0 8px;opacity:.38;transition:opacity .2s}
.nb.active{opacity:1}
.nb svg{width:21px;height:21px;stroke:var(--t)}
.nb span{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t2)}
.nb.active svg{stroke:var(--g)}.nb.active span{color:var(--g)}
.lbl{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.7px;display:block;margin-bottom:7px}
.ir{display:flex;gap:10px;margin-bottom:13px}.ir>*{flex:1}
input,select{background:var(--inp);border:1.5px solid var(--bd2);color:var(--t);border-radius:var(--rs);padding:12px 13px;font-size:14px;font-family:'Inter',sans-serif;font-weight:500;width:100%;outline:none;transition:border-color .18s;-webkit-appearance:none}
input:focus,select:focus{border-color:var(--b)}
input::placeholder{color:var(--t3)}
select option{background:var(--bg3)}
.sw{position:relative;margin-bottom:8px}
.sw svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none}
.sw input{padding-left:38px;font-size:15px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.sw .fbtn{position:absolute;right:10px;top:50%;transform:translateY(-50%);padding:5px 11px;background:var(--b);color:#000;border:none;border-radius:20px;font-size:10px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer}
.fst{font-size:11px;color:var(--t3);margin-bottom:10px;min-height:16px}
.seg{display:flex;background:var(--bg3);border:1px solid var(--bd2);border-radius:var(--rs);padding:3px;gap:3px;margin-bottom:15px}
.sb{flex:1;padding:9px;border:none;border-radius:6px;font-size:13px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer;color:var(--t3);background:none;transition:all .15s}
.sb.active{background:var(--g);color:#000}
.abtn{width:100%;padding:14px;background:var(--g);color:#000;border:none;border-radius:var(--ra);font-size:15px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer;transition:opacity .15s;margin-top:2px}
.abtn:active{opacity:.8}
.res{margin-top:18px;display:none}.res.show{display:block}
.sccard{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);padding:20px;margin-bottom:11px;text-align:center}
.scring{width:96px;height:96px;margin:0 auto 10px;position:relative}
.scring svg{transform:rotate(-90deg)}
.scnum{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:26px;font-weight:800}
.vrd{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:20px;font-size:12px;font-weight:700;margin-top:9px}
.vg{background:var(--gd);color:var(--g)}.vy{background:var(--god);color:var(--go)}.vr{background:var(--rd);color:var(--r)}
.m2{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px}
.mb{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:13px}
.mb .ml{font-size:9px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.7px;margin-bottom:3px}
.mb .mv{font-size:18px;font-weight:700;letter-spacing:-.5px;line-height:1.2}
.mb .ms{font-size:10px;color:var(--t3);margin-top:2px}
.gr{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bd)}
.gr:last-child{border-bottom:none}
.gs{width:27px;height:27px;border-radius:6px;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--b)}
.wb{background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.28);border-radius:var(--rs);padding:11px 13px;display:flex;align-items:center;gap:9px;margin-bottom:11px}
.wb p{font-size:12px;color:var(--go);font-weight:500;line-height:1.4}
.rrbar{display:flex;height:7px;border-radius:4px;overflow:hidden;gap:2px;margin-bottom:11px}
.pill{display:inline-block;padding:3px 8px;border-radius:9px;font-size:10px;font-weight:700}
.pb{background:var(--bd3);color:var(--b)}.pg{background:var(--gd);color:var(--g)}
.pr{background:var(--rd);color:var(--r)}.pgo{background:var(--god);color:var(--go)}
.tabs{display:flex;gap:8px;overflow-x:auto;margin-bottom:15px;padding-bottom:2px}.tabs::-webkit-scrollbar{display:none}
.tab{padding:7px 13px;border-radius:20px;font-size:12px;font-weight:600;background:var(--bg3);border:1px solid var(--bd2);color:var(--t2);cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.tab.active{background:var(--g);border-color:var(--g);color:#000}
.br{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(--bd)}
.br:last-child{border-bottom:none}
.bl{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;flex-shrink:0}
.ni{padding:11px 0;border-bottom:1px solid var(--bd);display:flex;gap:11px}
.ni:last-child{border-bottom:none}
.nd{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.xp{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);padding:14px;margin-bottom:10px}
.xa{width:37px;height:37px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;flex-shrink:0}
.xv{display:inline-block;width:13px;height:13px;background:var(--b);border-radius:50%;text-align:center;line-height:13px;font-size:7px;margin-left:3px;color:#000;font-weight:900}
.sr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-bottom:15px}
.sb2{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:13px;text-align:center}
.cw{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);height:170px;margin-bottom:12px;position:relative;overflow:hidden}
.cw svg{width:100%;height:100%;position:absolute}
.ti{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);padding:15px;margin-bottom:10px}
.tst{display:flex;gap:14px;flex-wrap:wrap}
.tsi{font-size:11px;color:var(--t3)}.tsi span{display:block;font-size:12px;font-weight:600;color:var(--t);margin-top:2px}
.sg{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);overflow:hidden;margin-bottom:11px}
.si{display:flex;align-items:center;justify-content:space-between;padding:15px 17px;border-bottom:1px solid var(--bd)}
.si:last-child{border-bottom:none}
.sii{width:31px;height:31px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.tog{width:43px;height:25px;background:var(--bg4);border-radius:13px;position:relative;cursor:pointer;transition:background .18s;border:none;flex-shrink:0}
.tog.on{background:var(--g)}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:19px;height:19px;background:#fff;border-radius:50%;transition:transform .18s}
.tog.on::after{transform:translateX(18px)}
.thsw{display:flex;background:var(--bg3);border:1px solid var(--bd2);border-radius:20px;padding:3px;gap:2px}
.thb{padding:5px 10px;border-radius:16px;font-size:10px;font-weight:700;cursor:pointer;color:var(--t3);transition:all .15s;border:none;background:none;font-family:'Inter',sans-serif}
.thb.active{background:var(--g);color:#000}
.mc2{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--ra);overflow:hidden;margin-bottom:11px}
.mth{width:100%;height:160px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer}
.ld{display:flex;align-items:center;gap:6px;padding:4px 11px;border-radius:20px;background:rgba(255,61,87,.14);border:1px solid rgba(255,61,87,.35)}
.ld::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--r);animation:pls 1.2s infinite}
@keyframes pls{0%,100%{opacity:1}50%{opacity:.25}}
.ld span{font-size:10px;font-weight:700;color:var(--r);letter-spacing:.5px}
.pb2{width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,.14);border:2px solid rgba(255,255,255,.28);display:flex;align-items:center;justify-content:center}
.lg{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px}
.lc{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:13px;cursor:pointer;transition:border-color .15s}
.lc:active{border-color:var(--g)}
.obtn{padding:8px 15px;background:var(--g);color:#000;border:none;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif}
.emb{width:100%;border:none;display:block;background:var(--bg4)}
.spin{display:inline-block;width:12px;height:12px;border:2px solid var(--bd2);border-top-color:var(--g);border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes sp{to{transform:rotate(360deg)}}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(10px)}
.modal-bg.hidden{display:none}
.modal{background:var(--bg3);border:1px solid var(--bd2);border-radius:20px;padding:28px 22px;width:100%;max-width:380px;max-height:90vh;overflow-y:auto}
.modal::-webkit-scrollbar{display:none}
.modal h2{font-family:'Times New Roman',Times,serif;font-size:22px;font-weight:700;margin-bottom:4px}
.modal p{font-size:13px;color:var(--t2);line-height:1.6;margin-bottom:18px}
.mbtn{width:100%;padding:14px;background:var(--g);color:#000;border:none;border-radius:var(--rs);font-size:15px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer;margin-top:6px}
.sec2btn{width:100%;padding:12px;background:var(--bg4);color:var(--t);border:1px solid var(--bd2);border-radius:var(--rs);font-size:13px;font-weight:600;font-family:'Inter',sans-serif;cursor:pointer;margin-top:8px}
.ai-box{background:linear-gradient(135deg,rgba(56,200,255,.08),rgba(0,200,83,.08));border:1px solid rgba(56,200,255,.25);border-radius:var(--ra);padding:16px;margin-bottom:11px}
.ai-box h4{font-size:13px;font-weight:700;margin-bottom:10px;color:var(--b)}
.ai-rec{padding:10px 12px;background:rgba(0,0,0,.15);border-radius:var(--rs);margin-bottom:8px}
.ai-rec .art{font-size:12px;font-weight:700;margin-bottom:4px}
.ai-rec .ard{font-size:11px;color:var(--t2);line-height:1.5}
.empty{text-align:center;padding:50px 20px}
.empty svg{margin-bottom:14px;opacity:.25}
.empty p{font-size:14px;color:var(--t3)}
.prof-wrap{text-align:center;padding:18px 0 24px}
.prof-av{width:70px;height:70px;border-radius:50%;background:var(--b);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#000;margin:0 auto 12px;cursor:pointer}
.prof-edit{display:none;flex-direction:column;gap:9px;margin-top:10px;padding:0 10px}
.wl-remove{width:22px;height:22px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--t3);flex-shrink:0;border:none;font-family:'Inter',sans-serif}
.rpt-overlay{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;flex-direction:column;max-width:430px;margin:0 auto;transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1)}
.rpt-overlay.open{transform:translateY(0)}
.rpt-tb{display:flex;align-items:center;justify-content:space-between;padding:54px 20px 14px;border-bottom:1px solid var(--bd);flex-shrink:0}
.rpt-back{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:14px;font-weight:600;color:var(--t2)}
.rpt-body{flex:1;overflow-y:auto;padding:0 20px 100px}
.rpt-body::-webkit-scrollbar{display:none}
.verdict-ring{width:110px;height:110px;margin:0 auto 12px;position:relative}
.verdict-ring svg{transform:rotate(-90deg)}
.verdict-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:30px;font-weight:900}
.thesis-box{background:linear-gradient(135deg,rgba(56,200,255,.06),rgba(180,77,255,.06));border:1px solid rgba(56,200,255,.2);border-radius:var(--ra);padding:16px;margin-bottom:11px}
.thesis-box p{font-size:13px;color:var(--t2);line-height:1.7}
.flag-item{display:flex;align-items:flex-start;gap:9px;padding:8px 0;border-bottom:1px solid var(--bd);font-size:12px;color:var(--t2);line-height:1.5}
.flag-item:last-child{border-bottom:none}
.flag-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:4px}
.gen-btn{width:100%;padding:13px;border:none;border-radius:var(--ra);font-size:13px;font-weight:800;font-family:'Inter',sans-serif;cursor:pointer;margin-top:9px;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .15s}
.gen-btn:active{opacity:.8}
.progress-bar{height:3px;background:var(--bd);border-radius:2px;overflow:hidden;margin-bottom:18px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--g),var(--b));border-radius:2px;transition:width .4s ease;width:0%}
.rpt-load-row{display:flex;align-items:center;gap:8px;padding:11px 0;border-bottom:1px solid var(--bd);font-size:12px;color:var(--t3)}
.rpt-load-row:last-child{border-bottom:none}
.rpt-check{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0}
.ee-bar{height:8px;border-radius:4px;background:var(--bg4);overflow:hidden;margin:6px 0 3px}
.ee-fill{height:100%;border-radius:4px}
.flow-print{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:12px 14px;margin-bottom:9px}
.flow-badge{padding:3px 9px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:.4px}
.ai-est{font-size:9px;font-weight:600;color:var(--go);background:var(--god);padding:2px 7px;border-radius:9px;display:inline-block;margin-bottom:8px}
/* SIZE CALC */
.size-big{font-size:56px;font-weight:900;color:var(--g);line-height:1;text-align:center}
.size-label{font-size:12px;font-weight:700;color:var(--t3);letter-spacing:1px;text-align:center;margin-top:4px}
</style>
</head>
<body>

<!-- TRADE MODAL -->
<div class="modal-bg hidden" id="atm">
  <div class="modal">
    <h2>Log Trade</h2>
    <p>Record a trade to track performance and receive AI coaching.</p>
    <div class="seg" id="jt-seg">
      <button class="sb active" id="jt-opt-btn">Options</button>
      <button class="sb" id="jt-stk-btn">Stocks</button>
    </div>
    <div style="margin-bottom:12px"><label class="lbl">Ticker</label><input id="jt-tk" type="text" placeholder="TICKER" style="text-transform:uppercase"/></div>
    <div class="ir">
      <div><label class="lbl">Direction</label><select id="jt-dir"><option>Call</option><option>Put</option><option>Long</option><option>Short</option></select></div>
      <div><label class="lbl">Trade Date</label><input id="jt-date" type="date"/></div>
    </div>
    <div id="jt-of">
      <div class="ir">
        <div><label class="lbl">Strike ($)</label><input id="jt-str" type="number" placeholder="Strike" step="0.5"/></div>
        <div><label class="lbl">Expiry</label><input id="jt-exp" type="date"/></div>
      </div>
      <div class="ir">
        <div><label class="lbl">Entry Premium ($)</label><input id="jt-en" type="number" placeholder="Entry" step="0.01"/></div>
        <div><label class="lbl">Exit Premium ($)</label><input id="jt-ex" type="number" placeholder="0 = open" step="0.01"/></div>
      </div>
      <div style="margin-bottom:12px"><label class="lbl">Contracts</label><input id="jt-qty" type="number" placeholder="1" min="1" value="1"/></div>
    </div>
    <div id="jt-sf" style="display:none">
      <div class="ir">
        <div><label class="lbl">Entry ($)</label><input id="jts-en" type="number" placeholder="Entry" step="0.01"/></div>
        <div><label class="lbl">Exit ($)</label><input id="jts-ex" type="number" placeholder="Exit" step="0.01"/></div>
      </div>
      <div style="margin-bottom:12px"><label class="lbl">Shares</label><input id="jts-qty" type="number" placeholder="Shares" min="1"/></div>
    </div>
    <div style="margin-bottom:12px"><label class="lbl">Notes</label><input id="jt-notes" type="text" placeholder="Your thesis"/></div>
    <button class="mbtn" id="jt-save-btn">Save Trade</button>
    <button class="sec2btn" id="jt-cancel-btn">Cancel</button>
  </div>
</div>

<!-- REPORT OVERLAY -->
<div class="rpt-overlay" id="rpt-overlay">
  <div class="rpt-tb">
    <div class="rpt-back" id="rpt-back">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>Back
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--b);background:var(--bd3);padding:4px 10px;border-radius:20px" id="rpt-ticker-badge">--</div>
  </div>
  <div class="rpt-body" id="rpt-body"></div>
</div>

<!-- HOME -->
<div class="screen active" id="screen-home">
  <div class="tb">
    <div class="lw">
      <svg width="28" height="24" viewBox="0 0 120 100"><g fill="#38c8ff"><ellipse cx="60" cy="58" rx="28" ry="16" transform="rotate(-15 60 58)"/><ellipse cx="76" cy="38" rx="10" ry="16" transform="rotate(-30 76 38)"/><ellipse cx="88" cy="24" rx="10" ry="7" transform="rotate(-20 88 24)"/><path d="M78 22 Q82 14 86 20 Q80 18 78 22Z"/><polygon points="91,17 94,11 96,18"/><ellipse cx="68" cy="36" rx="8" ry="12" transform="rotate(-10 68 36)"/><circle cx="72" cy="22" r="7"/><path d="M72 15 Q68 6 74 4 Q76 10 72 15Z"/><line x1="60" y1="28" x2="112" y2="6" stroke="#38c8ff" stroke-width="2.5" stroke-linecap="round"/><polygon points="112,6 106,8 110,12"/><path d="M86 12 Q92 10 96 14 Q90 16 86 12Z"/><path d="M52 68 Q46 78 44 88" stroke="#38c8ff" stroke-width="5" stroke-linecap="round" fill="none"/><path d="M58 70 Q56 80 50 86" stroke="#38c8ff" stroke-width="5" stroke-linecap="round" fill="none"/><path d="M36 64 Q30 74 34 84" stroke="#38c8ff" stroke-width="5" stroke-linecap="round" fill="none"/><path d="M42 66 Q40 76 38 86" stroke="#38c8ff" stroke-width="5" stroke-linecap="round" fill="none"/><path d="M34 58 Q20 52 18 62 Q22 68 30 64" fill="#38c8ff"/></g></svg>
      <h1>Shadow<span class="fx">fax</span></h1>
    </div>
    <div style="display:flex;gap:8px">
      <div class="ibtn" id="refresh-btn"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--t2)" stroke-width="2.2" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></div>
      <div class="av" id="hav"></div>
    </div>
  </div>
  <div class="scr">
    <p class="sec" style="margin-top:16px">Markets <span id="mtime" style="text-transform:none;letter-spacing:0;font-size:10px;font-weight:400;color:var(--t3)"></span></p>
    <div class="hs">
      <div class="mc"><div class="mc-l">S&amp;P 500</div><div class="mc-v" id="h-spy">--</div><div class="mc-c" id="h-spy-c">--</div></div>
      <div class="mc"><div class="mc-l">Nasdaq</div><div class="mc-v" id="h-qqq">--</div><div class="mc-c" id="h-qqq-c">--</div></div>
      <div class="mc"><div class="mc-l">VIX</div><div class="mc-v" id="h-vix">--</div><div class="mc-c" id="h-vix-c">--</div></div>
      <div class="mc"><div class="mc-l">10Y Yield</div><div class="mc-v" id="h-tnx">--</div><div class="mc-c" id="h-tnx-c">--</div></div>
      <div class="mc"><div class="mc-l">Gold</div><div class="mc-v" id="h-gld">--</div><div class="mc-c" id="h-gld-c">--</div></div>
      <div class="mc"><div class="mc-l">Oil WTI</div><div class="mc-v" id="h-oil">--</div><div class="mc-c" id="h-oil-c">--</div></div>
    </div>
    <p class="sec">Market Sentiment</p>
    <div class="card" style="padding:16px 18px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:14px;font-weight:600">Fear &amp; Greed Index</span>
        <div class="badge" id="fgi-badge" style="background:var(--gd);color:var(--g)">--</div>
      </div>
      <div class="sbar"><div class="sneedle" id="fgi-n" style="left:50%"></div></div>
      <div class="slabs"><span>Extreme Fear</span><span>Neutral</span><span>Extreme Greed</span></div>
      <div id="fgi-source" style="font-size:9px;color:var(--t3);text-align:center;margin-top:6px;font-weight:500">Source: CNN Fear &amp; Greed Index</div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:22px;margin-bottom:11px">
      <span class="sec" style="margin:0">Macro Regime</span>
      <button id="macro-load-btn" style="padding:4px 12px;background:var(--bd3);color:var(--b);border-radius:20px;font-size:11px;font-weight:700;border:none;cursor:pointer;font-family:Inter,sans-serif">Detect</button>
    </div>
    <div id="macro-wrap"><div class="card" style="text-align:center;padding:20px"><div style="font-size:13px;color:var(--t3)">Tap Detect to identify current macro regime</div><div style="font-size:11px;color:var(--t3);margin-top:6px">Rates, inflation, risk appetite, best strategies</div></div></div>
    <p class="sec">Top Movers</p>
    <div class="hs">
      <div class="mc" style="min-width:92px"><div style="font-size:12px;font-weight:700">NVDA</div><div class="mc-v" id="h-nvda" style="font-size:14px">--</div><div class="mc-c" id="h-nvda-c">--</div></div>
      <div class="mc" style="min-width:92px"><div style="font-size:12px;font-weight:700">AAPL</div><div class="mc-v" id="h-aapl" style="font-size:14px">--</div><div class="mc-c" id="h-aapl-c">--</div></div>
      <div class="mc" style="min-width:92px"><div style="font-size:12px;font-weight:700">TSLA</div><div class="mc-v" id="h-tsla" style="font-size:14px">--</div><div class="mc-c" id="h-tsla-c">--</div></div>
      <div class="mc" style="min-width:92px"><div style="font-size:12px;font-weight:700">META</div><div class="mc-v" id="h-meta" style="font-size:14px">--</div><div class="mc-c" id="h-meta-c">--</div></div>
      <div class="mc" style="min-width:92px"><div style="font-size:12px;font-weight:700">PLTR</div><div class="mc-v" id="h-pltr" style="font-size:14px">--</div><div class="mc-c" id="h-pltr-c">--</div></div>
      <div class="mc" style="min-width:92px"><div style="font-size:12px;font-weight:700">AMD</div><div class="mc-v" id="h-amd" style="font-size:14px">--</div><div class="mc-c" id="h-amd-c">--</div></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:22px;margin-bottom:11px">
      <span class="sec" style="margin:0">Watchlist</span>
      <span id="wl-add-toggle" style="cursor:pointer;padding:4px 12px;background:var(--bd3);color:var(--b);border-radius:20px;font-size:11px;font-weight:700">+ Add</span>
    </div>
    <div id="wl-add-row" style="display:none;margin-bottom:10px"><div style="display:flex;gap:8px"><input id="wl-input" type="text" placeholder="TICKER" maxlength="10" style="flex:1"/><button id="wl-add-btn" style="padding:12px 16px;background:var(--g);color:#000;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer">Add</button></div></div>
    <div id="watchlist-wrap" class="card" style="padding:0 15px"></div>
  </div>
</div>

<!-- ANALYZER -->
<div class="screen" id="screen-analyze">
  <div class="tb"><h1 style="font-size:20px;font-weight:700">Analyzer</h1><div style="padding:5px 12px;background:var(--bd3);border-radius:20px;font-size:10px;font-weight:700;color:var(--b)">PRO</div></div>
  <div class="scr">
    <div class="seg" id="aseg">
      <button class="sb active" id="asset-opt-btn">&#128202; Options</button>
      <button class="sb" id="asset-stk-btn">&#128200; Stocks</button>
      <button class="sb" id="asset-size-btn">&#128208; Size</button>
    </div>

    <!-- OPTIONS FIELDS -->
    <div id="opt-f">
      <div class="sw">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--t3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="tk-in" type="text" placeholder="TICKER" maxlength="6"/>
        <button id="fetch-btn" class="fbtn">Fetch Price</button>
      </div>
      <div id="fst" class="fst"></div>
      <div style="margin-bottom:12px"><label class="lbl">Current Stock Price ($)</label><input id="spx-in" type="number" placeholder="Auto-filled on fetch" step="0.01"/></div>
      <div class="ir">
        <div><label class="lbl">Option Type</label><select id="ot"><option value="call">Call</option><option value="put">Put</option></select></div>
        <div><label class="lbl">Expiry Date</label><select id="oexp"></select></div>
      </div>
      <div class="ir">
        <div><label class="lbl">Strike Price ($)</label><input id="sk-in" type="number" placeholder="Strike" step="0.5"/></div>
        <div><label class="lbl">Premium Paid ($)</label><input id="pm-in" type="number" placeholder="Premium" step="0.01"/></div>
      </div>
      <div style="margin-bottom:4px"><label class="lbl">Contracts</label><input id="ct-in" type="number" placeholder="1" min="1" value="1"/></div>
      <div style="display:flex;align-items:center;gap:9px;margin-bottom:13px;padding:10px 13px;background:var(--bg3);border:1px solid var(--bd2);border-radius:var(--rs)">
        <input type="checkbox" id="zdteMode" style="width:16px;height:16px;flex-shrink:0;border-radius:4px;cursor:pointer"/>
        <label for="zdteMode" style="font-size:12px;color:var(--t2);cursor:pointer">0DTE / Same-day expiry mode (adjusts scoring for intentional short-dated trades)</label>
      </div>
    </div>

    <!-- STOCKS FIELDS -->
    <div id="stk-f" style="display:none">
      <div class="sw">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--t3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="tk-in-s" type="text" placeholder="TICKER" maxlength="6"/>
        <button id="fetch-btn-s" class="fbtn">Fetch Price</button>
      </div>
      <div id="fst-s" class="fst"></div>
      <div style="margin-bottom:12px"><label class="lbl">Current Price ($)</label><input id="spx-in-s" type="number" placeholder="Auto-filled on fetch" step="0.01"/></div>
      <div class="ir">
        <div><label class="lbl">Entry Price ($)</label><input id="se-in" type="number" placeholder="Entry" step="0.01"/></div>
        <div><label class="lbl">Price Target ($)</label><input id="st-in" type="number" placeholder="Target" step="0.01"/></div>
      </div>
      <div class="ir">
        <div><label class="lbl">Stop Loss ($)</label><input id="sl-in" type="number" placeholder="Stop" step="0.01"/></div>
        <div><label class="lbl">Shares</label><input id="sh-in" type="number" placeholder="Qty" min="1"/></div>
      </div>
    </div>

    <!-- POSITION SIZE FIELDS -->
    <div id="size-f" style="display:none">
      <div style="background:var(--bd3);border-radius:var(--rs);padding:11px 13px;margin-bottom:13px;font-size:12px;color:var(--b);line-height:1.5">Calculates exact position size so you never risk more than your set limit. Uses your account size and risk % from Settings.</div>
      <div class="ir">
        <div><label class="lbl">Account Size ($)</label><input id="sz-acct" type="number" placeholder="e.g. 25000" step="100"/></div>
        <div><label class="lbl">Risk Per Trade (%)</label><input id="sz-risk" type="number" placeholder="2" step="0.5" min="0.1" max="10"/></div>
      </div>
      <div class="seg" id="szaseg">
        <button class="sb active" id="sz-stk-btn">Stock</button>
        <button class="sb" id="sz-opt-btn">Options</button>
      </div>
      <div id="sz-stk-f">
        <div class="ir">
          <div><label class="lbl">Entry Price ($)</label><input id="sz-entry" type="number" placeholder="Entry" step="0.01"/></div>
          <div><label class="lbl">Stop Loss ($)</label><input id="sz-stop" type="number" placeholder="Stop" step="0.01"/></div>
        </div>
      </div>
      <div id="sz-opt-f" style="display:none">
        <div class="ir">
          <div><label class="lbl">Premium per Contract ($)</label><input id="sz-prem" type="number" placeholder="e.g. 2.50" step="0.01"/></div>
          <div><label class="lbl">Max Loss Rule</label>
            <select id="sz-loss-type">
              <option value="full">Full Premium</option>
              <option value="half">50% of Premium</option>
              <option value="custom">Custom Stop ($)</option>
            </select>
          </div>
        </div>
        <div id="sz-custom-wrap" style="display:none;margin-bottom:13px"><label class="lbl">Custom Max Loss per Contract ($)</label><input id="sz-custom" type="number" placeholder="e.g. 75" step="1"/></div>
      </div>
      <div id="sz-res"></div>
      <button class="abtn" id="sz-calc-btn" style="margin-top:4px">Calculate Position Size</button>
    </div>

    <button class="abtn" id="analyze-btn">Analyze Trade</button>
    <button class="gen-btn" id="gen-report-btn" style="background:linear-gradient(135deg,#00c853,#00a844);color:#000">&#9889; Generate Pre-Trade Report</button>
    <button class="gen-btn" id="earnings-edge-btn" style="background:linear-gradient(135deg,#b44dff,#8a2be2);color:#fff">&#128202; Earnings Volatility Edge</button>
    <div id="ee-res" style="display:none;margin-top:4px"></div>

    <div class="res" id="res">
      <div class="dv"></div>
      <div id="ew" class="wb" style="display:none"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--go)" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg><p id="et"></p></div>
      <div id="opt-res">
        <div class="sccard">
          <div class="scring"><svg viewBox="0 0 100 100" width="96" height="96"><circle cx="50" cy="50" r="42" stroke="var(--bg4)" stroke-width="9" fill="none"/><circle id="sarc" cx="50" cy="50" r="42" stroke="var(--g)" stroke-width="9" fill="none" stroke-dasharray="263.9" stroke-dashoffset="79" stroke-linecap="round"/></svg><div class="scnum" id="snum" style="color:var(--g)">--</div></div>
          <div style="font-size:11px;color:var(--t3)">Premium Score</div>
          <div class="vrd vg" id="vrd">--</div>
        </div>
        <div class="m2">
          <div class="mb"><div class="ml">Break-Even</div><div class="mv" id="bev">--</div><div class="ms" id="bep">--</div></div>
          <div class="mb"><div class="ml">Implied Volatility</div><div class="mv" id="ivv" style="color:var(--b)">--</div><div class="ms" id="ivl">--</div></div>
          <div class="mb"><div class="ml">Prob. Profit</div><div class="mv up" id="prv">--</div><div class="ms">Based on delta</div></div>
          <div class="mb"><div class="ml">Theta / Day</div><div class="mv dn" id="thv">--</div><div class="ms">Time decay cost</div></div>
          <div class="mb"><div class="ml">Total Cost</div><div class="mv" id="tcv">--</div><div class="ms">Premium x 100 x qty</div></div>
          <div class="mb"><div class="ml">Days to Expiry</div><div class="mv" id="dtev">--</div><div class="ms">Calendar days</div></div>
        </div>
        <div class="card"><h4>Risk / Reward</h4>
          <div class="rrbar"><div style="background:var(--r);flex:1"></div><div style="background:var(--g);flex:2.3"></div></div>
          <div style="display:flex;justify-content:space-between">
            <div style="font-size:12px;color:var(--t3)">Max Loss<span id="mlv" style="display:block;font-size:14px;font-weight:700;color:var(--r);margin-top:2px"></span></div>
            <div style="font-size:12px;color:var(--t3);text-align:center">Ratio<span id="rrr" style="display:block;font-size:14px;font-weight:700;color:var(--t);margin-top:2px"></span></div>
            <div style="font-size:12px;color:var(--t3);text-align:right">Max Gain<span id="mgv" style="display:block;font-size:14px;font-weight:700;color:var(--g);margin-top:2px"></span></div>
          </div>
        </div>
        <div class="card"><h4>Greeks Breakdown</h4>
          <div class="gr"><div style="display:flex;align-items:center;gap:9px"><div class="gs">&#916;</div><div><div style="font-size:13px;font-weight:600">Delta</div><div style="font-size:10px;color:var(--t3)" id="dld">--</div></div></div><div style="font-size:14px;font-weight:700" id="dlv">--</div></div>
          <div class="gr"><div style="display:flex;align-items:center;gap:9px"><div class="gs">&#915;</div><div><div style="font-size:13px;font-weight:600">Gamma</div><div style="font-size:10px;color:var(--t3)">Delta change per $1 move</div></div></div><div style="font-size:14px;font-weight:700" id="gmv">--</div></div>
          <div class="gr"><div style="display:flex;align-items:center;gap:9px"><div class="gs">&#920;</div><div><div style="font-size:13px;font-weight:600">Theta</div><div style="font-size:10px;color:var(--t3)">Daily premium decay</div></div></div><div style="font-size:14px;font-weight:700;color:var(--r)" id="tgv">--</div></div>
          <div class="gr"><div style="display:flex;align-items:center;gap:9px"><div class="gs">V</div><div><div style="font-size:13px;font-weight:600">Vega</div><div style="font-size:10px;color:var(--t3)">Gain per 1% IV increase</div></div></div><div style="font-size:14px;font-weight:700;color:var(--g)" id="vgv">--</div></div>
          <div class="gr"><div style="display:flex;align-items:center;gap:9px"><div class="gs">&#961;</div><div><div style="font-size:13px;font-weight:600">Rho</div><div style="font-size:10px;color:var(--t3)">Rate sensitivity</div></div></div><div style="font-size:14px;font-weight:700" id="rhv">--</div></div>
        </div>
      </div>
      <div id="stk-res" style="display:none">
        <div class="sccard"><div style="font-size:42px;font-weight:800;color:var(--g);line-height:1" id="sgrd">--</div><div style="font-size:11px;color:var(--t3);margin-top:6px">Setup Grade</div><div class="vrd vg" id="svrd">--</div></div>
        <div class="m2">
          <div class="mb"><div class="ml">Upside</div><div class="mv up" id="sup">--</div><div class="ms">To price target</div></div>
          <div class="mb"><div class="ml">Downside</div><div class="mv dn" id="sdn">--</div><div class="ms">To stop loss</div></div>
          <div class="mb"><div class="ml">R:R Ratio</div><div class="mv" id="srr">--</div><div class="ms">Reward per $1 risk</div></div>
          <div class="mb"><div class="ml">Position Size</div><div class="mv" id="sps">--</div><div class="ms">Total capital</div></div>
        </div>
      </div>
      <div class="card" id="bb-box">
        <h4>&#127968; Bulge Bracket Targets <span id="bbt" style="color:var(--t3);font-weight:500"></span></h4>
        <div class="br"><div style="display:flex;align-items:center;gap:9px"><div class="bl" style="background:#00408018;color:#3a7bd5">GS</div><div><div style="font-size:13px;font-weight:700">Goldman Sachs</div><div id="gs-rt" style="font-size:11px">--</div></div></div><div style="text-align:right"><div id="gs-pt" style="font-size:17px;font-weight:800">--</div><div id="gs-up" style="font-size:11px">--</div></div></div>
        <div class="br"><div style="display:flex;align-items:center;gap:9px"><div class="bl" style="background:#00204018;color:#005a9e">MS</div><div><div style="font-size:13px;font-weight:700">Morgan Stanley</div><div id="ms-rt" style="font-size:11px">--</div></div></div><div style="text-align:right"><div id="ms-pt" style="font-size:17px;font-weight:800">--</div><div id="ms-up" style="font-size:11px">--</div></div></div>
        <div class="br"><div style="display:flex;align-items:center;gap:9px"><div class="bl" style="background:#00008018;color:#002d6b">JPM</div><div><div style="font-size:13px;font-weight:700">JP Morgan</div><div id="jpm-rt" style="font-size:11px">--</div></div></div><div style="text-align:right"><div id="jpm-pt" style="font-size:17px;font-weight:800">--</div><div id="jpm-up" style="font-size:11px">--</div></div></div>
        <div class="br"><div style="display:flex;align-items:center;gap:9px"><div class="bl" style="background:#8b000018;color:#c0392b">BAC</div><div><div style="font-size:13px;font-weight:700">Bank of America</div><div id="bac-rt" style="font-size:11px">--</div></div></div><div style="text-align:right"><div id="bac-pt" style="font-size:17px;font-weight:800">--</div><div id="bac-up" style="font-size:11px">--</div></div></div>
        <div class="br" style="border-bottom:none"><div style="display:flex;align-items:center;gap:9px"><div class="bl" style="background:#00555518;color:#006060">CITI</div><div><div style="font-size:13px;font-weight:700">Citigroup</div><div id="ci-rt" style="font-size:11px">--</div></div></div><div style="text-align:right"><div id="ci-pt" style="font-size:17px;font-weight:800">--</div><div id="ci-up" style="font-size:11px">--</div></div></div>
        <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--bd);font-size:10px;color:var(--t3)">Reference only. Not financial advice.</div>
      </div>
    </div>
  </div>
</div>

<!-- SIGNALS -->
<div class="screen" id="screen-sentiment">
  <div class="tb"><h1 style="font-size:20px;font-weight:700">Signals</h1></div>
  <div class="scr">
    <div class="sw" style="margin-bottom:6px">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--t3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="stk" type="text" placeholder="TICKER OR COMPANY NAME"/>
      <button id="signals-load-btn" class="fbtn">Load</button>
    </div>
    <div id="sst" class="fst" style="margin-bottom:14px"></div>
    <div class="tabs">
      <div class="tab active" id="st-ov">Overview</div>
      <div class="tab" id="st-news">&#128240; News</div>
      <div class="tab" id="st-x">&#120143; X Feed</div>
      <div class="tab" id="st-ana">Analysts</div>
      <div class="tab" id="st-flow">&#128011; Flow</div>
    </div>
    <div id="sent-ov"><div class="empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><p>Search a ticker to load live signals</p></div></div>
    <div id="sent-news" style="display:none"><div class="empty"><p style="color:var(--t3)">Search a ticker to load news</p></div></div>
    <div id="sent-x" style="display:none"><div class="empty"><p style="color:var(--t3)">Search a ticker to load X signals</p></div></div>
    <div id="sent-ana" style="display:none"><div class="empty"><p style="color:var(--t3)">Search a ticker to load analyst ratings</p></div></div>
    <div id="sent-flow" style="display:none"><div class="empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><p>Search a ticker then tap Flow</p></div></div>
  </div>
</div>

<!-- MEDIA -->
<div class="screen" id="screen-media">
  <div class="tb"><h1 style="font-size:20px;font-weight:700">Media</h1><div style="padding:4px 10px;background:var(--rd);border:1px solid rgba(255,61,87,.3);border-radius:20px;display:flex;align-items:center;gap:5px"><span style="width:6px;height:6px;border-radius:50%;background:var(--r);display:inline-block;animation:pls 1.2s infinite"></span><span style="font-size:10px;font-weight:700;color:var(--r)">LIVE</span></div></div>
  <div class="scr">
    <div class="tabs">
      <div class="tab active" id="mt-live">&#128250; Live TV</div>
      <div class="tab" id="mt-charts">&#128202; Charts</div>
      <div class="tab" id="mt-news">&#128240; News</div>
      <div class="tab" id="mt-tools">&#128295; Tools</div>
    </div>
    <div id="m-live">
      <div class="mc2"><div class="mth" style="background:linear-gradient(135deg,#1a1a2e,#16213e)" id="bb-open"><div style="font-size:28px;font-weight:900;color:#fff;letter-spacing:-1px">Bloomberg</div><div style="display:flex;gap:10px;margin-top:6px"><div class="ld"><span>LIVE</span></div><div class="pb2"><svg width="17" height="17" viewBox="0 0 24 24" fill="#fff"><polygon points="5 3 19 12 5 21 5 3"/></svg></div></div></div><div style="padding:13px 15px"><div style="font-size:14px;font-weight:700">Bloomberg TV</div><div style="font-size:11px;color:var(--t3);margin-top:3px">24/7 global business and markets</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:9px"><span class="pill pr">LIVE</span><button class="obtn" id="bb-btn">Watch Live</button></div></div></div>
      <div class="mc2"><div class="mth" style="background:linear-gradient(135deg,#003087,#0057b8)" id="cnbc-open"><div style="font-size:34px;font-weight:900;color:#fff;letter-spacing:2px">CNBC</div><div style="display:flex;gap:10px;margin-top:6px"><div class="ld"><span>LIVE</span></div><div class="pb2"><svg width="17" height="17" viewBox="0 0 24 24" fill="#fff"><polygon points="5 3 19 12 5 21 5 3"/></svg></div></div></div><div style="padding:13px 15px"><div style="font-size:14px;font-weight:700">CNBC Live</div><div style="font-size:11px;color:var(--t3);margin-top:3px">Markets, analysts, breaking news</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:9px"><span class="pill pr">LIVE</span><button class="obtn" id="cnbc-btn">Watch Live</button></div></div></div>
      <div class="mc2"><div class="mth" style="background:linear-gradient(135deg,#400090,#6001d2)" id="yf-open"><div style="font-size:20px;font-weight:900;color:#fff">Yahoo Finance</div><div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:3px">Markets and Investing</div><div style="display:flex;gap:10px;margin-top:8px"><div class="ld"><span>LIVE</span></div><div class="pb2"><svg width="17" height="17" viewBox="0 0 24 24" fill="#fff"><polygon points="5 3 19 12 5 21 5 3"/></svg></div></div></div><div style="padding:13px 15px"><div style="font-size:14px;font-weight:700">Yahoo Finance Live</div><div style="font-size:11px;color:var(--t3);margin-top:3px">Free live stream, data and commentary</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:9px"><span class="pill pg">FREE LIVE</span><button class="obtn" id="yf-btn">Watch Live</button></div></div></div>
    </div>
    <div id="m-charts" style="display:none">
      <div class="card" style="padding:0;overflow:hidden"><div style="padding:13px 15px 9px;font-size:13px;font-weight:700">TradingView Live Chart</div><iframe class="emb" style="height:310px" src="https://s.tradingview.com/widgetembed/?frameElementId=tv1&symbol=NASDAQ%3AAAPL&interval=D&hidesidetoolbar=0&hideTopBar=0&theme=dark&style=1&locale=en&toolbar_bg=%230a0a0a&enable_publishing=0&allow_symbol_change=1&save_image=0" frameborder="0" allowtransparency="true" scrolling="no"></iframe></div>
      <div class="card" style="padding:0;overflow:hidden"><div style="padding:13px 15px 9px;font-size:13px;font-weight:700">Market Overview</div><iframe class="emb" style="height:400px" src="https://s.tradingview.com/embed-widget/market-overview/?locale=en#%7B%22colorTheme%22%3A%22dark%22%2C%22dateRange%22%3A%221D%22%2C%22showChart%22%3Atrue%2C%22locale%22%3A%22en%22%2C%22isTransparent%22%3Afalse%2C%22showSymbolLogo%22%3Atrue%2C%22width%22%3A%22100%25%22%2C%22height%22%3A%22100%25%22%2C%22tabs%22%3A%5B%7B%22title%22%3A%22Indices%22%2C%22symbols%22%3A%5B%7B%22s%22%3A%22FOREXCOM%3ASPXUSD%22%2C%22d%22%3A%22S%26P+500%22%7D%2C%7B%22s%22%3A%22FOREXCOM%3ANSXUSD%22%2C%22d%22%3A%22Nasdaq+100%22%7D%2C%7B%22s%22%3A%22FOREXCOM%3ADJI%22%2C%22d%22%3A%22Dow+Jones%22%7D%5D%7D%2C%7B%22title%22%3A%22Commodities%22%2C%22symbols%22%3A%5B%7B%22s%22%3A%22TVC%3AGOLD%22%2C%22d%22%3A%22Gold%22%7D%2C%7B%22s%22%3A%22TVC%3AUSOIL%22%2C%22d%22%3A%22Oil+WTI%22%7D%5D%7D%2C%7B%22title%22%3A%22Bonds%22%2C%22symbols%22%3A%5B%7B%22s%22%3A%22TVC%3AUS10Y%22%2C%22d%22%3A%2210Y+Yield%22%7D%5D%7D%5D%7D" frameborder="0" allowtransparency="true" scrolling="no"></iframe></div>
    </div>
    <div id="m-news" style="display:none"><div class="lg">
      <div class="lc" id="mw-btn"><div style="font-size:22px;margin-bottom:7px">&#128202;</div><div style="font-size:13px;font-weight:700">MarketWatch</div><span class="pill pb" style="margin-top:6px;display:inline-block">FREE</span></div>
      <div class="lc" id="sa-btn"><div style="font-size:22px;margin-bottom:7px">&#128269;</div><div style="font-size:13px;font-weight:700">Seeking Alpha</div><span class="pill pb" style="margin-top:6px;display:inline-block">FREE</span></div>
      <div class="lc" id="uw-btn"><div style="font-size:22px;margin-bottom:7px">&#128011;</div><div style="font-size:13px;font-weight:700">Unusual Whales</div><span class="pill pg" style="margin-top:6px;display:inline-block">FLOW</span></div>
      <div class="lc" id="bz-btn"><div style="font-size:22px;margin-bottom:7px">&#9889;</div><div style="font-size:13px;font-weight:700">Benzinga</div><span class="pill pb" style="margin-top:6px;display:inline-block">FREE</span></div>
      <div class="lc" id="fv-btn"><div style="font-size:22px;margin-bottom:7px">&#128506;</div><div style="font-size:13px;font-weight:700">Finviz</div><span class="pill pg" style="margin-top:6px;display:inline-block">FREE</span></div>
      <div class="lc" id="ba-btn"><div style="font-size:22px;margin-bottom:7px">&#128240;</div><div style="font-size:13px;font-weight:700">Barrons</div><span class="pill pgo" style="margin-top:6px;display:inline-block">PREMIUM</span></div>
    </div></div>
    <div id="m-tools" style="display:none"><div class="lg">
      <div class="lc" id="tv-btn"><div style="font-size:22px;margin-bottom:7px">&#128200;</div><div style="font-size:13px;font-weight:700">TradingView</div><span class="pill pb" style="margin-top:6px;display:inline-block">CHARTS</span></div>
      <div class="lc" id="os-btn"><div style="font-size:22px;margin-bottom:7px">&#127919;</div><div style="font-size:13px;font-weight:700">OptionStrat</div><span class="pill pgo" style="margin-top:6px;display:inline-block">OPTIONS</span></div>
      <div class="lc" id="cb-btn"><div style="font-size:22px;margin-bottom:7px">&#127963;</div><div style="font-size:13px;font-weight:700">CBOE</div><span class="pill pg" style="margin-top:6px;display:inline-block">DATA</span></div>
      <div class="lc" id="fred-btn"><div style="font-size:22px;margin-bottom:7px">&#128201;</div><div style="font-size:13px;font-weight:700">FRED</div><span class="pill pgo" style="margin-top:6px;display:inline-block">MACRO</span></div>
      <div class="lc" id="sec-btn"><div style="font-size:22px;margin-bottom:7px">&#128203;</div><div style="font-size:13px;font-weight:700">SEC EDGAR</div><span class="pill pb" style="margin-top:6px;display:inline-block">FILINGS</span></div>
      <div class="lc" id="yo-btn"><div style="font-size:22px;margin-bottom:7px">&#128208;</div><div style="font-size:13px;font-weight:700">Yahoo Options</div><span class="pill pg" style="margin-top:6px;display:inline-block">FREE</span></div>
    </div></div>
  </div>
</div>

<!-- JOURNAL -->
<div class="screen" id="screen-journal">
  <div class="tb"><h1 style="font-size:20px;font-weight:700">Journal</h1><div style="padding:7px 13px;background:var(--g);border-radius:20px;font-size:12px;font-weight:700;color:#000;cursor:pointer" id="open-at-btn">+ Log Trade</div></div>
  <div class="scr">
    <div class="sr3" id="j-stats" style="display:none">
      <div class="sb2"><div style="font-size:20px;font-weight:800" id="jwr">--</div><div style="font-size:9px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-top:4px">Win Rate</div></div>
      <div class="sb2"><div style="font-size:17px;font-weight:800" id="jpnl">--</div><div style="font-size:9px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-top:4px">Total P&amp;L</div></div>
      <div class="sb2"><div style="font-size:20px;font-weight:800" id="jcnt">--</div><div style="font-size:9px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-top:4px">Trades</div></div>
    </div>
    <div class="cw" id="jchart" style="display:none">
      <div style="position:absolute;top:13px;left:15px;font-size:12px;font-weight:600;color:var(--t3);z-index:2">P&amp;L Curve</div>
      <div style="position:absolute;top:11px;right:15px;font-size:14px;font-weight:700;z-index:2" id="jcv"></div>
      <svg id="jsvg" viewBox="0 0 400 170" preserveAspectRatio="none"></svg>
    </div>
    <div id="jai-wrap" style="display:none">
      <div class="ai-box"><h4>&#129302; AI Coaching</h4><div id="jai"><button class="abtn" style="background:var(--b);font-size:13px;padding:11px" id="ai-recs-btn">Get AI Analysis</button></div></div>
    </div>
    <div id="j-empty" class="empty">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      <p style="margin-bottom:16px">No trades logged yet.</p>
      <button class="abtn" style="max-width:200px;margin:0 auto;display:block;font-size:13px;padding:11px" id="log-first-btn">Log Your First Trade</button>
    </div>
    <p class="sec" id="j-tt" style="display:none">Trade History</p>
    <div id="j-trades"></div>
  </div>
</div>

<!-- SETTINGS -->
<div class="screen" id="screen-settings">
  <div class="tb"><h1 style="font-size:20px;font-weight:700">Settings</h1></div>
  <div class="scr">
    <div class="prof-wrap">
      <div class="prof-av" id="sav"></div>
      <div style="font-size:17px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px" id="prof-name-row">
        <span id="pnm">Tap to set your name</span>
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </div>
      <div style="font-size:12px;color:var(--t3);margin-top:4px" id="pac"></div>
      <div style="font-size:10px;color:var(--t3);margin-top:5px;opacity:.5">Tap name or avatar to edit</div>
      <div class="prof-edit" id="ped">
        <input id="en" type="text" placeholder="Your Name"/>
        <input id="ea" type="number" placeholder="Account Size ($)"/>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button id="save-pro-btn" style="flex:1;padding:10px;background:var(--g);color:#000;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:'Inter',sans-serif;cursor:pointer">Save</button>
          <button id="cancel-pro-btn" style="flex:1;padding:10px;background:var(--bg4);color:var(--t);border:none;border-radius:var(--rs);font-size:13px;font-weight:600;font-family:'Inter',sans-serif;cursor:pointer">Cancel</button>
        </div>
      </div>
    </div>
    <p class="sec">Appearance</p>
    <div class="sg"><div class="si" style="justify-content:center;border:none"><div class="thsw"><button class="thb active" id="th-dark">&#127769; Dark</button><button class="thb" id="th-light">&#9728; Light</button><button class="thb" id="th-sys">&#128241; System</button></div></div></div>
    <p class="sec">Preferences</p>
    <div class="sg">
      <div class="si" style="cursor:default">
        <div style="display:flex;align-items:center;gap:11px"><div class="sii" style="background:var(--gd)">&#128202;</div><div><div style="font-size:14px;font-weight:500">Risk Per Trade</div><div style="font-size:11px;color:var(--t3)">Max loss per trade</div></div></div>
        <select id="risk-sel" style="width:auto;padding:7px 12px;font-size:13px;font-weight:600;border-radius:20px;background:var(--bg4);border:1.5px solid var(--bd2);color:var(--t);cursor:pointer"><option value="1">1%</option><option value="2" selected>2%</option><option value="3">3%</option><option value="5">5%</option></select>
      </div>
      <div class="si"><div style="display:flex;align-items:center;gap:11px"><div class="sii" style="background:var(--bd3)">&#128276;</div><div><div style="font-size:14px;font-weight:500">Push Notifications</div><div style="font-size:11px;color:var(--t3)">Alerts and signals</div></div></div><button class="tog on" id="tog-notif"></button></div>
      <div class="si"><div style="display:flex;align-items:center;gap:11px"><div class="sii" style="background:var(--god)">&#9889;</div><div><div style="font-size:14px;font-weight:500">TradingView Webhooks</div><div style="font-size:11px;color:var(--t3)">Auto-analyze on alert</div></div></div><button class="tog" id="tog-webhook"></button></div>
      <div class="si"><div style="display:flex;align-items:center;gap:11px"><div class="sii" style="background:var(--rd)">&#128737;</div><div><div style="font-size:14px;font-weight:500">Risk Manager</div><div style="font-size:11px;color:var(--t3)">Portfolio protection rules</div></div></div><button class="tog on" id="tog-risk"></button></div>
    </div>
    <p class="sec">Journal</p>
    <div class="sg"><div class="si" id="clear-j-btn"><div style="display:flex;align-items:center;gap:11px"><div class="sii" style="background:var(--rd)">&#128465;</div><div><div style="font-size:14px;font-weight:500;color:var(--r)">Clear Journal</div><div style="font-size:11px;color:var(--t3)">Delete all trade history</div></div></div><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--t3)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div></div>
  </div>
</div>

<!-- NAV -->
<nav class="nav">
  <div class="nb active" id="nav-home"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></div>
  <div class="nb" id="nav-analyze"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span>Analyze</span></div>
  <div class="nb" id="nav-sentiment"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Signals</span></div>
  <div class="nb" id="nav-media"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2"/><polyline points="17 2 12 7 7 2"/></svg><span>Media</span></div>
  <div class="nb" id="nav-journal"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>Journal</span></div>
  <div class="nb" id="nav-settings"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg><span>Settings</span></div>
</nav>

<script>
(function(){
'use strict';
var user={name:'',initials:'',accountSize:'',riskPct:2,theme:'dark'};
var journal=[],jtType='option',watchlist=[],priceCache={};
var sigTicker='',flowLoaded=false;
var WL_COLORS=['#38c8ff','#b44dff','#f5c842','#00c853','#ff3d57','#ff9800','#03a9f4','#e91e63'];

function sv(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function ld(k,fb){try{var v=localStorage.getItem(k);return v!==null?JSON.parse(v):fb;}catch(e){return fb;}}
function gel(id){return document.getElementById(id);}
function setText(id,v){var e=gel(id);if(e)e.textContent=v;}

/* NAV */
function goNav(sid){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('active');});var sc=gel('screen-'+sid),nb=gel('nav-'+sid);if(sc)sc.classList.add('active');if(nb)nb.classList.add('active');var scr=sc&&sc.querySelector('.scr');if(scr)scr.scrollTo(0,0);}
['home','analyze','sentiment','media','journal','settings'].forEach(function(id){gel('nav-'+id).addEventListener('click',function(){goNav(id);});});
gel('hav').addEventListener('click',function(){goNav('settings');});

/* THEME */
function applyTheme(t){var a=t==='system'?(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'):t;document.documentElement.setAttribute('data-theme',a);}
function setTheme(t){sv('sfx_theme',t);applyTheme(t);highlightThBtn(t);}
function highlightThBtn(t){['th-dark','th-light','th-sys'].forEach(function(id){var e=gel(id);if(e)e.classList.remove('active');});var map={dark:'th-dark',light:'th-light',system:'th-sys'};var e=gel(map[t]);if(e)e.classList.add('active');}
gel('th-dark').addEventListener('click',function(){setTheme('dark');});
gel('th-light').addEventListener('click',function(){setTheme('light');});
gel('th-sys').addEventListener('click',function(){setTheme('system');});
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',function(){if(ld('sfx_theme','dark')==='system')applyTheme('system');});

/* PROFILE */
function applyUser(){var i=user.initials||(user.name?user.name[0].toUpperCase():'?');['hav','sav'].forEach(function(id){var e=gel(id);if(e)e.textContent=i;});setText('pnm',user.name||'Tap to set your name');setText('pac',user.accountSize?'Account: $'+Number(user.accountSize).toLocaleString():'');var rs=gel('risk-sel');if(rs&&user.riskPct)rs.value=String(user.riskPct);var en=gel('en');if(en)en.value=user.name||'';var ea=gel('ea');if(ea)ea.value=user.accountSize||'';}
function togglePE(){var e=gel('ped');e.style.display=e.style.display==='flex'?'none':'flex';if(e.style.display==='flex')e.style.flexDirection='column';}
gel('sav').addEventListener('click',togglePE);
gel('prof-name-row').addEventListener('click',togglePE);
gel('save-pro-btn').addEventListener('click',function(){var n=(gel('en').value||'').trim();if(!n)return;user.name=n;user.accountSize=gel('ea').value;user.initials=n.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);sv('sfx_user',user);applyUser();togglePE();});
gel('cancel-pro-btn').addEventListener('click',togglePE);
gel('risk-sel').addEventListener('change',function(){user.riskPct=parseFloat(this.value)||2;sv('sfx_user',user);});
['tog-notif','tog-webhook','tog-risk'].forEach(function(id){var e=gel(id);if(e)e.addEventListener('click',function(){this.classList.toggle('on');});});

/* AI */
async function callAI(prompt,useSearch,maxTok){try{var body={messages:[{role:'user',content:prompt}],max_tokens:maxTok||800};if(useSearch)body.use_search=true;var r=await fetch('/api/ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(r.ok){var d=await r.json();if(!d.error)return(d.content||[]).map(function(b){return b.type==='text'?b.text:'';}).join('');}}catch(e){}return null;}
function parseJSON(txt){if(!txt)return null;try{txt=txt.replace(/```json/g,'').replace(/```/g,'');var s=txt.indexOf('{'),e=txt.lastIndexOf('}');return s>=0?JSON.parse(txt.slice(s,e+1)):null;}catch(e){return null;}}

/* PRICES */
async function fetchBulk(syms){try{var r=await fetch('/api/quotes?symbols='+encodeURIComponent(syms.join(',')),{signal:AbortSignal.timeout(10000)});if(r.ok){var d=await r.json();var res=d&&d.quoteResponse&&d.quoteResponse.result;if(res&&res.length){var c={};res.forEach(function(q){c[q.symbol]={price:q.price||0,chg:q.chg||0,pct:q.pct||0};});return c;}}}catch(e){}return null;}
async function loadPrices(){
  var t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});setText('mtime','- '+t);
  var core=['^GSPC','^IXIC','^VIX','^TNX','GC=F','CL=F','NVDA','AAPL','TSLA','META','PLTR','AMD'];
  var all=core.slice();watchlist.forEach(function(tk){if(all.indexOf(tk)<0)all.push(tk);});
  var cache=await fetchBulk(all);if(!cache)return;priceCache=cache;
  function setQ(vid,cid,sym,fmt){var q=cache[sym];if(!q||!q.price)return;var ve=gel(vid),ce=gel(cid),p=q.price;var disp=fmt==='vix'?p.toFixed(2):fmt==='pct'?p.toFixed(2)+'%':fmt==='idx'?p.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+p.toFixed(2);if(ve)ve.textContent=disp;if(ce){ce.textContent=(q.chg>=0?'+ ':'-')+Math.abs(q.pct).toFixed(2)+'%';ce.className='mc-c '+(q.chg>=0?'up':'dn');}}
  setQ('h-spy','h-spy-c','^GSPC','idx');setQ('h-qqq','h-qqq-c','^IXIC','idx');setQ('h-vix','h-vix-c','^VIX','vix');setQ('h-tnx','h-tnx-c','^TNX','pct');setQ('h-gld','h-gld-c','GC=F','usd');setQ('h-oil','h-oil-c','CL=F','usd');
  setQ('h-nvda','h-nvda-c','NVDA','usd');setQ('h-aapl','h-aapl-c','AAPL','usd');setQ('h-tsla','h-tsla-c','TSLA','usd');setQ('h-meta','h-meta-c','META','usd');setQ('h-pltr','h-pltr-c','PLTR','usd');setQ('h-amd','h-amd-c','AMD','usd');
  renderWatchlist(cache);
  loadFearAndGreed();
}
gel('refresh-btn').addEventListener('click',function(){window.location.reload();});

async function loadFearAndGreed(){
  try{
    var r=await fetch('/api/fng',{signal:AbortSignal.timeout(8000)});
    if(!r.ok)return;
    var d=await r.json();
    if(d.error||d.score===undefined)return;
    var score=Math.round(d.score);
    /* CNN ratings: Extreme Fear, Fear, Neutral, Greed, Extreme Greed */
    var label=d.rating||( score>=75?'Extreme Greed':score>=55?'Greed':score>=45?'Neutral':score>=25?'Fear':'Extreme Fear');
    var badge=gel('fgi-badge'),needle=gel('fgi-n');
    if(badge){
      badge.textContent=label+' ('+score+')';
      badge.style.background=score>=75?'var(--gd)':score>=55?'var(--gd)':score>=45?'var(--god)':score>=25?'var(--rd)':'var(--rd)';
      badge.style.color=score>=55?'var(--g)':score>=45?'var(--go)':'var(--r)';
    }
    if(needle)needle.style.left=score+'%';
    /* update label under bar to show CNN source */
    var src=document.getElementById('fgi-source');
    if(src)src.textContent='Source: CNN Fear & Greed Index';
  }catch(e){}
}

/* WATCHLIST */
function renderWatchlist(cache){var wrap=gel('watchlist-wrap');if(!wrap)return;wrap.innerHTML='';if(!watchlist.length){var empty=document.createElement('div');empty.style.cssText='padding:20px;text-align:center;color:var(--t3);font-size:13px';empty.textContent='No tickers yet. Tap + Add to build your watchlist.';wrap.appendChild(empty);return;}watchlist.forEach(function(tk,i){var q=cache?cache[tk]:null,col=WL_COLORS[i%WL_COLORS.length];var price=(q&&q.price)?'$'+q.price.toFixed(2):'--',chgTxt=q?((q.chg>=0?'+ ':'-')+Math.abs(q.pct).toFixed(2)+'%'):'--',chgCls=q?(q.chg>=0?'up':'dn'):'';var row=document.createElement('div');row.className='wli';if(i===watchlist.length-1)row.style.borderBottom='none';var left=document.createElement('div');left.style.cssText='display:flex;align-items:center;gap:11px';var icon=document.createElement('div');icon.className='wlic';icon.style.cssText='background:'+col+'1a;color:'+col;icon.textContent=tk.length>4?tk.slice(0,4):tk;var nameEl=document.createElement('div');nameEl.style.cssText='font-size:15px;font-weight:700';nameEl.textContent=tk;left.appendChild(icon);left.appendChild(nameEl);var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');svg.setAttribute('class','sp');svg.setAttribute('viewBox','0 0 60 28');var poly=document.createElementNS('http://www.w3.org/2000/svg','polyline');poly.setAttribute('points','0,18 10,14 20,16 30,10 40,12 50,8 60,10');poly.setAttribute('stroke',col);poly.setAttribute('stroke-width','1.5');poly.setAttribute('fill','none');svg.appendChild(poly);var right=document.createElement('div');right.style.cssText='display:flex;align-items:center;gap:8px';var pDiv=document.createElement('div');pDiv.style.cssText='text-align:right';var pVal=document.createElement('div');pVal.style.cssText='font-size:15px;font-weight:600';pVal.textContent=price;var cVal=document.createElement('div');cVal.className=chgCls;cVal.style.fontSize='11px';cVal.textContent=chgTxt;pDiv.appendChild(pVal);pDiv.appendChild(cVal);var rmBtn=document.createElement('button');rmBtn.className='wl-remove';rmBtn.textContent='x';(function(sym){rmBtn.addEventListener('click',function(){removeWL(sym);});})(tk);right.appendChild(pDiv);right.appendChild(rmBtn);row.appendChild(left);row.appendChild(svg);row.appendChild(right);wrap.appendChild(row);});}
gel('wl-add-toggle').addEventListener('click',function(){var d=gel('wl-add-row');d.style.display=d.style.display==='block'?'none':'block';if(d.style.display==='block')setTimeout(function(){gel('wl-input').focus();},50);});
gel('wl-input').addEventListener('input',function(){this.value=this.value.toUpperCase().replace(/[^A-Z0-9^.=]/g,'');});
gel('wl-input').addEventListener('keydown',function(e){if(e.key==='Enter')addWL();});
gel('wl-add-btn').addEventListener('click',addWL);
async function addWL(){var tk=(gel('wl-input').value||'').trim().toUpperCase();if(!tk||watchlist.indexOf(tk)>=0){gel('wl-add-row').style.display='none';return;}watchlist.push(tk);sv('sfx_watchlist',watchlist);gel('wl-input').value='';gel('wl-add-row').style.display='none';renderWatchlist(priceCache);var extra=await fetchBulk([tk]);if(extra){priceCache[tk]=extra[tk];renderWatchlist(priceCache);}}
function removeWL(tk){watchlist=watchlist.filter(function(t){return t!==tk;});sv('sfx_watchlist',watchlist);renderWatchlist(priceCache);}

/* MACRO REGIME */
gel('macro-load-btn').addEventListener('click',loadMacroRegime);
async function loadMacroRegime(){
  var btn=gel('macro-load-btn');
  btn.innerHTML='<span class="spin" style="width:10px;height:10px;margin:0;margin-right:4px"></span>';
  var wrap=gel('macro-wrap');
  wrap.innerHTML='<div class="card" style="text-align:center;padding:18px"><span class="spin"></span> Fetching live macro data from FRED + Yahoo...</div>';
  try{
    var r=await fetch('/api/macro',{signal:AbortSignal.timeout(15000)});
    btn.textContent='Refresh';
    if(!r.ok){throw new Error('API error');}
    var d=await r.json();
    if(d.error){throw new Error(d.error);}
    renderMacro(d,wrap);
  }catch(e){
    btn.textContent='Retry';
    wrap.innerHTML='<div class="card" style="text-align:center;padding:18px;color:var(--r)">Could not load macro data. Check FRED_API_KEY is set in Vercel.</div>';
  }
}

function renderMacro(d,wrap){
  var col=d.color==='green'?'var(--g)':d.color==='red'?'var(--r)':'var(--go)';
  var bg=d.color==='green'?'var(--gd)':d.color==='red'?'var(--rd)':'var(--god)';
  var sigCol={bullish:'var(--g)',neutral:'var(--go)',caution:'var(--go)',bearish:'var(--r)'};

  /* Header card */
  var html='<div class="card" style="padding:18px;margin-bottom:9px">';
  html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">';
  html+='<div style="font-size:17px;font-weight:800;color:'+col+'">'+d.regime+'</div>';
  html+='<div style="background:'+bg+';color:'+col+';padding:6px 11px;border-radius:20px;font-size:11px;font-weight:700">'+d.label+'</div></div>';
  html+='<div style="font-size:11px;color:var(--t3);margin-bottom:14px;line-height:1.5">'+d.summary+'</div>';

  /* Score bar */
  html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
  html+='<span style="font-size:11px;color:var(--t3)">Regime Score</span>';
  html+='<span style="font-size:13px;font-weight:800;color:'+col+'">'+d.score+' / 100</span></div>';
  html+='<div style="height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;margin-bottom:14px">';
  html+='<div style="width:'+d.score+'%;height:100%;background:'+col+';border-radius:3px;transition:width .6s ease"></div></div>';

  /* Key metrics grid */
  html+='<div class="m2" style="margin-bottom:0">';
  html+='<div class="mb"><div class="ml">Fed Rate</div><div class="mv" style="font-size:14px;color:var(--b)">'+d.rateEnv+'</div></div>';
  html+='<div class="mb"><div class="ml">CPI YoY</div><div class="mv" style="font-size:14px;color:var(--b)">'+d.inflationEnv+'</div></div>';
  html+='<div class="mb"><div class="ml">VIX</div><div class="mv" style="font-size:14px;color:var(--b)">'+d.vixLevel+'</div></div>';
  html+='<div class="mb"><div class="ml">Yield Curve</div><div class="mv" style="font-size:14px;color:var(--b)">'+d.yieldCurve+'</div></div>';
  html+='<div class="mb"><div class="ml">Unemployment</div><div class="mv" style="font-size:14px;color:var(--b)">'+d.unemployment+'</div></div>';
  html+='<div class="mb"><div class="ml">Risk Appetite</div><div class="mv" style="font-size:14px;color:'+col+'">'+d.riskAppetite+'</div></div>';
  html+='</div>';
  html+='<div style="margin-top:9px;padding-top:9px;border-top:1px solid var(--bd);font-size:9px;color:var(--t3);text-align:right">Data: Federal Reserve FRED + Yahoo Finance</div>';
  html+='</div>';

  /* Factor breakdown */
  if(d.factors&&d.factors.length){
    html+='<div class="card" style="margin-bottom:9px"><div style="font-size:11px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.7px;margin-bottom:10px">Factor Breakdown</div>';
    d.factors.forEach(function(f){
      var fc=sigCol[f.s]||'var(--t3)';
      html+='<div style="display:flex;align-items:flex-start;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bd)">';
      html+='<div><div style="font-size:12px;font-weight:700">'+f.n+'</div><div style="font-size:10px;color:var(--t3);margin-top:2px">'+f.note+'</div></div>';
      html+='<div style="text-align:right;flex-shrink:0;margin-left:9px"><div style="font-size:13px;font-weight:700;color:'+fc+'">'+f.v+'</div>';
      html+='<div style="font-size:9px;font-weight:700;color:'+fc+';text-transform:uppercase;letter-spacing:.5px">'+f.s+'</div></div></div>';
    });
    html+='</div>';
  }

  /* Favor / Avoid */
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:9px">';
  if(d.favorStrategies&&d.favorStrategies.length){
    html+='<div class="card" style="margin-bottom:0"><div style="font-size:10px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px">Favor</div>';
    d.favorStrategies.forEach(function(s){html+='<div style="font-size:11px;color:var(--t2);padding:4px 0;border-bottom:1px solid var(--bd);line-height:1.4">'+s+'</div>';});
    html+='</div>';
  }
  if(d.avoidStrategies&&d.avoidStrategies.length){
    html+='<div class="card" style="margin-bottom:0"><div style="font-size:10px;font-weight:700;color:var(--r);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px">Avoid</div>';
    d.avoidStrategies.forEach(function(s){html+='<div style="font-size:11px;color:var(--t2);padding:4px 0;border-bottom:1px solid var(--bd);line-height:1.4">'+s+'</div>';});
    html+='</div>';
  }
  html+='</div>';
  wrap.innerHTML=html;
}

/* BLACK-SCHOLES */
function nc(x){var a1=.254829592,a2=-.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=.3275911,s=x<0?-1:1;x=Math.abs(x)/Math.SQRT2;var t=1/(1+p*x),y=1-(((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);return.5*(1+s*y);}
function np(x){return Math.exp(-.5*x*x)/Math.sqrt(2*Math.PI);}
function d1f(S,K,T,r,v){return(Math.log(S/K)+(r+.5*v*v)*T)/(v*Math.sqrt(T));}
function bsp(S,K,T,r,v,tp){if(T<=0)return tp==='call'?Math.max(S-K,0):Math.max(K-S,0);var d1=d1f(S,K,T,r,v),d2=d1-v*Math.sqrt(T);return tp==='call'?S*nc(d1)-K*Math.exp(-r*T)*nc(d2):K*Math.exp(-r*T)*nc(-d2)-S*nc(-d1);}
function calcIV(mp,S,K,T,r,tp){if(T<=0)return.3;var v=.3;for(var i=0;i<100;i++){var pr=bsp(S,K,T,r,v,tp),vg=S*np(d1f(S,K,T,r,v))*Math.sqrt(T),df=pr-mp;if(Math.abs(df)<.0001||Math.abs(vg)<.0001)break;v-=df/vg;v=Math.max(.01,Math.min(5,v));}return v;}
function gks(S,K,T,r,v,tp){if(T<=0)return{delta:tp==='call'?1:0,gamma:0,theta:0,vega:0,rho:0};var d1=d1f(S,K,T,r,v),d2=d1-v*Math.sqrt(T);return{delta:tp==='call'?nc(d1):nc(d1)-1,gamma:np(d1)/(S*v*Math.sqrt(T)),theta:(tp==='call'?-(S*np(d1)*v)/(2*Math.sqrt(T))-r*K*Math.exp(-r*T)*nc(d2):-(S*np(d1)*v)/(2*Math.sqrt(T))+r*K*Math.exp(-r*T)*nc(-d2))/365,vega:S*np(d1)*Math.sqrt(T)*.01,rho:tp==='call'?K*T*Math.exp(-r*T)*nc(d2)*.01:-K*T*Math.exp(-r*T)*nc(-d2)*.01};}

/* 
   PREMIUM SCORE  FIXED & CALIBRATED
   Sources: delta-based prob profit, IV fair value, 
   OTM distance penalty, DTE penalty, 0DTE mode
 */
function calcPremScore(S,K,tp,dte,G,sigma,prem,zdteMode){
  var r=.0428,T=dte/365;
  /* Fair value ratio: how much did you overpay vs Black-Scholes? */
  var theo=bsp(S,K,T,r,sigma,tp);
  var fairRatio=prem>0?Math.min(1.5,theo/prem):1; /* >1 = cheap, <1 = expensive */
  /* Delta probability component (0-40 pts) */
  var deltaProb=Math.abs(G.delta); /* 0-1 range */
  var deltaScore=deltaProb*40;
  /* Fair value component (0-40 pts): pays full 40 if you bought at or below fair */
  var fairScore=Math.min(40,fairRatio*40);
  /* OTM penalty  applied to both components */
  var otmPct=tp==='call'?(K-S)/S:(S-K)/S;
  var otmPen=otmPct>0.20?50:otmPct>0.12?35:otmPct>0.06?18:otmPct>0.02?8:0;
  /* DTE penalty  FIXED: 0DTE mode bypasses this entirely */
  var dtePen=0;
  if(!zdteMode){dtePen=dte<=2?50:dte<=5?35:dte<=10?18:dte<=21?7:0;}
  /* Low delta penalty: punish lottery tickets */
  var dltPen=deltaProb<0.08?25:deltaProb<0.15?12:deltaProb<0.25?4:0;
  var raw=deltaScore+fairScore-otmPen-dtePen-dltPen;
  return Math.max(5,Math.min(92,Math.round(raw)));
}

/* 
   SCORE THRESHOLDS  TIGHTENED
   68+ = Worth It (was 65)
   45-67 = Borderline (tighter band)
   <45 = High Risk
 */
function scoreLabel(sc){return sc>=68?'Worth It':sc>=45?'Borderline':'High Risk - Reconsider';}
function scoreClass(sc){return sc>=68?'vg':sc>=45?'vy':'vr';}

/* ANALYZER */
gel('asset-opt-btn').addEventListener('click',function(){switchAsset('options',this);});
gel('asset-stk-btn').addEventListener('click',function(){switchAsset('stocks',this);});
gel('asset-size-btn').addEventListener('click',function(){switchAsset('size',this);});
gel('analyze-btn').addEventListener('click',runAnalysis);
gel('gen-report-btn').addEventListener('click',openReport);
gel('earnings-edge-btn').addEventListener('click',runEarningsEdge);
gel('sz-calc-btn').addEventListener('click',calcSize);
gel('sz-loss-type').addEventListener('change',function(){gel('sz-custom-wrap').style.display=this.value==='custom'?'block':'none';});
gel('sz-stk-btn').addEventListener('click',function(){document.querySelectorAll('#szaseg .sb').forEach(function(b){b.classList.remove('active');});this.classList.add('active');gel('sz-stk-f').style.display='block';gel('sz-opt-f').style.display='none';gel('sz-res').innerHTML='';});
gel('sz-opt-btn').addEventListener('click',function(){document.querySelectorAll('#szaseg .sb').forEach(function(b){b.classList.remove('active');});this.classList.add('active');gel('sz-stk-f').style.display='none';gel('sz-opt-f').style.display='block';gel('sz-res').innerHTML='';});

function switchAsset(tp,btn){
  document.querySelectorAll('#aseg .sb').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');
  gel('opt-f').style.display=tp==='options'?'block':'none';
  gel('stk-f').style.display=tp==='stocks'?'block':'none';
  gel('size-f').style.display=tp==='size'?'block':'none';
  gel('res').classList.remove('show');
  gel('ee-res').style.display='none';
  gel('analyze-btn').style.display=tp==='size'?'none':'block';
  gel('gen-report-btn').style.display=tp==='size'?'none':'flex';
  gel('earnings-edge-btn').style.display=tp==='size'?'none':'flex';
  if(tp==='size'){
    var sa=gel('sz-acct');if(sa&&!sa.value&&user.accountSize)sa.value=user.accountSize;
    var sr=gel('sz-risk');if(sr&&!sr.value&&user.riskPct)sr.value=String(user.riskPct);
  }
}

var currentTk='';
function syncTk(){var v=gel('tk-in').value.trim().toUpperCase();currentTk=v;}
gel('tk-in').addEventListener('input',function(){this.value=this.value.toUpperCase();currentTk=this.value.trim();});
gel('tk-in').addEventListener('blur',function(){if(this.value.trim().length>=1)fetchPxOpt();});
gel('fetch-btn').addEventListener('click',fetchPxOpt);
gel('tk-in-s').addEventListener('input',function(){this.value=this.value.toUpperCase();});
gel('tk-in-s').addEventListener('blur',function(){if(this.value.trim().length>=1)fetchPxStk();});
gel('fetch-btn-s').addEventListener('click',fetchPxStk);

async function fetchPxOpt(){var tk=gel('tk-in').value.trim().toUpperCase();if(!tk)return;var st=gel('fst');st.innerHTML='<span class="spin"></span>Fetching...';var cache=await fetchBulk([tk]);var q=cache?cache[tk]:null;if(q&&q.price){gel('spx-in').value=q.price.toFixed(2);var up=q.chg>=0;st.innerHTML='<span style="color:var(--g)">OK</span> '+tk+' $'+q.price.toFixed(2)+' <span class="'+(up?'up':'dn')+'">'+(up?'+':'')+q.pct.toFixed(2)+'%</span>';setBBT(tk,q.price);}else{st.innerHTML='<span style="color:var(--r)">Not found</span>';}}
async function fetchPxStk(){var tk=gel('tk-in-s').value.trim().toUpperCase();if(!tk)return;var st=gel('fst-s');st.innerHTML='<span class="spin"></span>Fetching...';var cache=await fetchBulk([tk]);var q=cache?cache[tk]:null;if(q&&q.price){gel('spx-in-s').value=q.price.toFixed(2);var up=q.chg>=0;st.innerHTML='<span style="color:var(--g)">OK</span> '+tk+' $'+q.price.toFixed(2)+' <span class="'+(up?'up':'dn')+'">'+(up?'+':'')+q.pct.toFixed(2)+'%</span>';setBBT(tk,q.price);}else{st.innerHTML='<span style="color:var(--r)">Not found</span>';}}

function setBBT(tk,px){setText('bbt',tk);[{id:'gs',rt:'Buy',m:1.22},{id:'ms',rt:'Overweight',m:1.17},{id:'jpm',rt:'Neutral',m:1.05},{id:'bac',rt:'Buy',m:1.25},{id:'ci',rt:'Sell',m:.87}].forEach(function(b){var pt=(px*b.m).toFixed(0),up=b.m>=1,ups=((b.m-1)*100).toFixed(1);var pe=gel(b.id+'-pt'),ue=gel(b.id+'-up'),re=gel(b.id+'-rt');if(pe){pe.textContent='$'+pt;pe.className=up?'up':'dn';}if(ue){ue.textContent=(up?'+':'')+ups+'%';ue.className=up?'up':'dn';}if(re){re.textContent=b.rt;re.style.color=(b.rt==='Buy'||b.rt==='Overweight')?'var(--g)':b.rt==='Sell'?'var(--r)':'var(--go)';}});}
function populateExpiries(){var sel=gel('oexp');if(!sel)return;sel.innerHTML='';var now=new Date(),dates=[];for(var i=1;i<=120;i++){var d=new Date(now);d.setDate(now.getDate()+i);if(d.getDay()===5){dates.push({d:d,label:d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})+' ('+i+'d)'});if(dates.length>=12)break;}}for(var m=1;m<=6;m++){var mo=new Date(now.getFullYear(),now.getMonth()+m,1),fri=0,day=new Date(mo);while(fri<3){if(day.getDay()===5)fri++;if(fri<3)day.setDate(day.getDate()+1);}var dte2=Math.ceil((day-now)/864e5);if(day>now&&!dates.find(function(x){return x.d.toDateString()===day.toDateString();}))dates.push({d:day,label:day.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})+' Monthly ('+dte2+'d)'});}dates.sort(function(a,b){return a.d-b.d;});dates.forEach(function(item){var o=document.createElement('option');o.value=item.d.toISOString().split('T')[0];o.textContent=item.label;sel.appendChild(o);});}

function runAnalysis(){var isOpt=gel('asset-opt-btn').classList.contains('active');var tk=isOpt?gel('tk-in').value.trim():gel('tk-in-s').value.trim();if(!tk){isOpt?gel('tk-in').focus():gel('tk-in-s').focus();return;}var btn=gel('analyze-btn');btn.textContent='Analyzing...';btn.style.opacity='.6';setTimeout(function(){btn.textContent='Analyze Trade';btn.style.opacity='1';isOpt?calcOpt():calcStk();gel('res').classList.add('show');gel('res').scrollIntoView({behavior:'smooth',block:'start'});},900);}

function calcOpt(){
  var S=parseFloat(gel('spx-in').value)||0,K=parseFloat(gel('sk-in').value)||0,prem=parseFloat(gel('pm-in').value)||0,qty=parseInt(gel('ct-in').value)||1,tp=gel('ot').value;
  var zdteMode=gel('zdteMode').checked;
  var exv=gel('oexp').value,exd=exv?new Date(exv):null,dte=exd?Math.max(1,Math.ceil((exd-new Date())/864e5)):30,T=dte/365,r=.0428;
  gel('opt-res').style.display='block';gel('stk-res').style.display='none';gel('bb-box').style.display='block';
  var be=(tp==='call'?K+prem:K-prem).toFixed(2),bePct=S>0?((parseFloat(be)-S)/S*100).toFixed(2):null;
  var sigma=.3;if(S>0&&K>0&&prem>0)sigma=calcIV(prem,S,K,T,r,tp);
  var G=(S>0&&K>0)?gks(S,K,T,r,sigma,tp):{delta:.38,gamma:.04,theta:-.012,vega:.15,rho:.08};
  var sc=(S>0&&K>0&&prem>0)?calcPremScore(S,K,tp,dte,G,sigma,prem,zdteMode):50;
  gel('sarc').setAttribute('stroke-dashoffset',(263.9-263.9*sc/100).toFixed(1));
  setText('snum',sc);
  var vb=gel('vrd');vb.className='vrd '+scoreClass(sc);vb.textContent=scoreLabel(sc)+(zdteMode&&dte<=5?' (0DTE mode)':'');
  setText('bev','$'+be);setText('bep',bePct!==null?(parseFloat(be)>=S?'+':'')+bePct+'% from current':'Enter stock price');
  setText('ivv',(sigma*100).toFixed(1)+'%');setText('ivl',sigma<.2?'Very low IV':sigma<.35?'Below avg':sigma<.55?'Above avg':'Very high IV');
  setText('prv',Math.round(Math.abs(G.delta)*100)+'%');setText('thv','$'+(Math.abs(G.theta*100*prem)).toFixed(2));
  setText('tcv','$'+(prem*100*qty).toLocaleString(undefined,{maximumFractionDigits:0}));setText('dtev',dte+' days');
  setText('mlv','$'+(prem*100*qty).toLocaleString());setText('mgv',tp==='call'?'Unlimited':'$'+((K-prem)*100*qty).toFixed(0));setText('rrr',tp==='call'?'unlimited:1':'1:1');
  setText('dlv',(G.delta>=0?'+':'')+G.delta.toFixed(3));setText('dld','Moves $'+Math.abs(G.delta).toFixed(2)+' per $1');
  setText('gmv',G.gamma.toFixed(4));setText('tgv','$'+(Math.abs(G.theta)*100*prem).toFixed(2));setText('vgv','$'+(G.vega*100).toFixed(2));setText('rhv',(G.rho>=0?'+':'')+G.rho.toFixed(3));
  var ew=gel('ew');if(dte<21&&!zdteMode){ew.style.display='flex';gel('et').innerHTML='Expiry in '+dte+' days - theta decay accelerates in final 2 weeks.';}else ew.style.display='none';
  if(S>0)setBBT(gel('tk-in').value.toUpperCase(),S);
}

function calcStk(){
  gel('opt-res').style.display='none';gel('stk-res').style.display='block';gel('bb-box').style.display='block';
  var en=parseFloat(gel('se-in').value)||0,tg=parseFloat(gel('st-in').value)||0,sl=parseFloat(gel('sl-in').value)||0,sh=parseInt(gel('sh-in').value)||0;
  if(en>0&&tg>0&&sl>0){
    var up=((tg-en)/en*100).toFixed(2),dn=((en-sl)/en*100).toFixed(2),ratio=((tg-en)/(en-sl)),pos=(en*sh).toFixed(0);
    setText('sup','+'+up+'%');setText('sdn',dn+'%');setText('srr',ratio.toFixed(2)+':1');setText('sps','$'+Number(pos).toLocaleString());
    /* FIXED R:R GRADES: min 3:1 for A, 2:1 for B+, 1.5:1 for C  tightened from before */
    var g,vc,vt;
    if(ratio>=3){g='A';vc='vg';vt='Excellent - 3:1 R:R or better';}
    else if(ratio>=2){g='B+';vc='vg';vt='Strong - 2:1 R:R or better';}
    else if(ratio>=1.5){g='C';vc='vy';vt='Acceptable minimum - 1.5:1 R:R';}
    else if(ratio>=1){g='D';vc='vr';vt='Weak - below professional minimum';}
    else{g='F';vc='vr';vt='Unacceptable - losing more than you gain';}
    setText('sgrd',g);var sv2=gel('svrd');sv2.className='vrd '+vc;sv2.textContent=vt;
    if(en>0)setBBT(gel('tk-in-s').value.toUpperCase(),parseFloat(gel('spx-in-s').value)||en);
  }
}

/* POSITION SIZING CALCULATOR */
function calcSize(){
  var acct=parseFloat(gel('sz-acct').value)||parseFloat(user.accountSize)||0;
  var riskPct=parseFloat(gel('sz-risk').value)||user.riskPct||2;
  var wrap=gel('sz-res');
  if(!acct){wrap.innerHTML='<div class="card" style="color:var(--r);text-align:center;padding:16px">Set your account size above or in Settings.</div>';return;}
  if(riskPct>10){wrap.innerHTML='<div class="card" style="color:var(--r);text-align:center;padding:16px">Risk above 10% per trade is outside any recommended framework.</div>';return;}
  var riskAmt=acct*(riskPct/100);
  var isOptSz=gel('sz-opt-btn').classList.contains('active');
  if(!isOptSz){
    var entry=parseFloat(gel('sz-entry').value)||0;
    var stop=parseFloat(gel('sz-stop').value)||0;
    if(!entry||!stop){wrap.innerHTML='<div class="card" style="color:var(--go);text-align:center;padding:16px">Enter entry and stop loss.</div>';return;}
    if(stop>=entry){wrap.innerHTML='<div class="card" style="color:var(--r);text-align:center;padding:16px">Stop must be below entry price.</div>';return;}
    var rps=entry-stop;
    var shares=Math.floor(riskAmt/rps);
    if(shares<1){wrap.innerHTML='<div class="card" style="color:var(--r);text-align:center;padding:16px">Risk amount too small for this setup. Widen stop or increase account risk %.</div>';return;}
    var capital=shares*entry;
    var acctPct=capital/acct*100;
    var kelly=getKellySize(acct,'stock',entry,null);
    renderSizeResult(wrap,shares,'SHARES',capital,acctPct,riskAmt,riskPct,[{l:'Risk Per Share',v:'$'+rps.toFixed(2),s:'Entry minus stop'},{l:'Stop Loss',v:'$'+stop.toFixed(2),s:'Exit if wrong'}],kelly,'shares');
  } else {
    var prem=parseFloat(gel('sz-prem').value)||0;
    var lossType=gel('sz-loss-type').value;
    var mlpc=lossType==='full'?prem*100:lossType==='half'?prem*50:(parseFloat(gel('sz-custom').value)||prem)*100;
    if(!prem||mlpc<=0){wrap.innerHTML='<div class="card" style="color:var(--go);text-align:center;padding:16px">Enter premium and max loss settings.</div>';return;}
    var contracts=Math.floor(riskAmt/mlpc);
    if(contracts<1){wrap.innerHTML='<div class="card" style="color:var(--r);text-align:center;padding:16px">Risk amount too small for even 1 contract.</div>';return;}
    var capital2=contracts*prem*100;
    var acctPct2=capital2/acct*100;
    var lossDesc=lossType==='full'?'Full premium':lossType==='half'?'50% stop':'Custom stop';
    var kelly2=getKellySize(acct,'option',null,mlpc);
    renderSizeResult(wrap,contracts,'CONTRACTS',capital2,acctPct2,contracts*mlpc,riskPct,[{l:'Max Loss/Contract',v:'$'+mlpc.toFixed(0),s:lossDesc},{l:'Total Premium',v:'$'+(prem*100*contracts).toFixed(0),s:contracts+' x $'+(prem*100).toFixed(0)}],kelly2,'contracts');
  }
}

function getKellySize(acct,mode,entry,mlpc){
  var trades=journal.filter(function(t){return t.status==='closed'&&(mode==='option'?t.assetClass==='option':t.assetClass!=='option');});
  if(trades.length<5)return null;
  var wins=trades.filter(function(t){return t.pnl>0;});
  var losses=trades.filter(function(t){return t.pnl<=0;});
  if(!wins.length||!losses.length)return null;
  var wp=wins.length/trades.length;
  var avgWin=wins.reduce(function(s,t){return s+Math.abs(t.retPct);},0)/wins.length;
  var avgLoss=losses.reduce(function(s,t){return s+Math.abs(t.retPct);},0)/losses.length;
  if(!avgLoss)return null;
  var b=avgWin/avgLoss;
  /* Half-Kelly for safety */
  var kelly=Math.max(0,Math.min(0.25,(b*wp-(1-wp))/b))*0.5;
  var kellyAmt=acct*kelly;
  if(mode==='stock'&&entry)return Math.max(1,Math.floor(kellyAmt/entry));
  if(mode==='option'&&mlpc)return Math.max(1,Math.floor(kellyAmt/mlpc));
  return null;
}

function renderSizeResult(wrap,primary,label,capital,acctPct,riskAmt,riskPct,details,kelly,kellyLabel){
  var oversize=acctPct>20;
  var medsize=acctPct>12&&acctPct<=20;
  var acctColor=oversize?'var(--r)':medsize?'var(--go)':'var(--g)';
  var html='<div style="background:linear-gradient(135deg,rgba(0,200,83,.08),rgba(56,200,255,.05));border:1px solid rgba(0,200,83,.3);border-radius:var(--ra);padding:20px;margin-bottom:11px;text-align:center">';
  html+='<div class="size-big">'+primary+'</div>';
  html+='<div class="size-label">'+label+'</div>';
  html+='</div>';
  html+='<div class="m2">';
  html+='<div class="mb"><div class="ml">Max Risk ($)</div><div class="mv dn">$'+Math.round(riskAmt).toLocaleString()+'</div><div class="ms">'+riskPct+'% of account</div></div>';
  html+='<div class="mb"><div class="ml">Capital Used</div><div class="mv">$'+Math.round(capital).toLocaleString()+'</div><div class="ms" style="color:'+acctColor+'">'+acctPct.toFixed(1)+'% of account</div></div>';
  details.forEach(function(d){html+='<div class="mb"><div class="ml">'+d.l+'</div><div class="mv" style="font-size:15px;color:var(--r)">'+d.v+'</div><div class="ms">'+d.s+'</div></div>';});
  html+='</div>';
  if(oversize){html+='<div class="wb" style="background:var(--rd);border-color:rgba(255,61,87,.35);margin-bottom:11px"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--r)" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg><p style="color:var(--r)">This position is '+acctPct.toFixed(1)+'% of your account. Exceeds the 20% max single-position limit. A full loss could cause serious drawdown.</p></div>';}
  else if(medsize){html+='<div class="wb" style="margin-bottom:11px"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--go)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/></svg><p>Position is '+acctPct.toFixed(1)+'% of account. Acceptable but approaching the upper limit. Monitor closely.</p></div>';}
  if(kelly!==null){
    var kDiff=kelly-primary;
    var kColor=kDiff>=0?'var(--g)':'var(--go)';
    var kMsg=kDiff>=0?'Your risk-based size is conservative. Based on your win rate and average win/loss, Half-Kelly allows up to '+kelly+' '+kellyLabel+'.':'Your historical performance suggests reducing to '+kelly+' '+kellyLabel+' (Half-Kelly from journal data).';
    html+='<div class="card" style="margin-bottom:11px"><div style="font-size:11px;font-weight:700;color:var(--p);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px">Half-Kelly Validation</div>';
    html+='<div style="font-size:20px;font-weight:800;color:'+kColor+'">'+kelly+' '+kellyLabel+'</div>';
    html+='<div style="font-size:12px;color:var(--t3);margin-top:5px;line-height:1.5">'+kMsg+'</div>';
    html+='<div style="font-size:10px;color:var(--t3);margin-top:6px;opacity:.7">Requires 5+ closed trades in journal. Half-Kelly applied for safety.</div></div>';
  }
  html+='<div style="background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:13px;font-size:11px;color:var(--t3);line-height:1.8">';
  html+='<div style="font-weight:700;color:var(--t2);margin-bottom:5px">Position Sizing Rules</div>';
  html+='Max 1-3% risk per trade. No single position over 20% of account. Scale down in high VIX. Never average down on losers. Cut at your stop  no exceptions.';
  html+='</div>';
  wrap.innerHTML=html;
  wrap.scrollIntoView({behavior:'smooth',block:'start'});
}

/* PRE-TRADE REPORT */
function openReport(){
  var tk=gel('tk-in').value.trim().toUpperCase();
  if(!tk){gel('tk-in').focus();alert('Enter a ticker first.');return;}
  setText('rpt-ticker-badge',tk);
  var body=gel('rpt-body');body.innerHTML='';
  var prog=document.createElement('div');prog.className='progress-bar';
  var fill=document.createElement('div');fill.className='progress-fill';
  prog.appendChild(fill);body.appendChild(prog);
  var steps=['Fetching live price','Running calculations','Loading sentiment','Generating thesis','Computing verdict'];
  var stepsCard=document.createElement('div');stepsCard.className='card';stepsCard.style.marginBottom='11px';
  stepsCard.innerHTML='<h4 style="margin-bottom:12px">Building your report...</h4>';
  steps.forEach(function(label,idx){var row=document.createElement('div');row.className='rpt-load-row';row.id='rstep-'+idx;row.innerHTML='<div class="rpt-check" style="background:var(--bg4);color:var(--t3)" id="rstep-icon-'+idx+'"><span class="spin" style="width:10px;height:10px;margin:0"></span></div><span>'+label+'</span>';stepsCard.appendChild(row);});
  body.appendChild(stepsCard);
  gel('rpt-overlay').classList.add('open');
  runReport(tk,body,fill,stepsCard,prog);
}
function doneStep(idx){var ic=gel('rstep-icon-'+idx);if(ic){ic.textContent='ok';ic.style.background='var(--gd)';ic.style.color='var(--g)';ic.style.fontSize='8px';ic.style.fontWeight='700';}}
async function runReport(tk,body,fill,stepsCard,prog){
  var isOpt=gel('asset-opt-btn').classList.contains('active');
  var S=parseFloat(gel('spx-in').value)||0,K=parseFloat(gel('sk-in').value)||0,prem=parseFloat(gel('pm-in').value)||0,tp=gel('ot').value;
  var zdteMode=gel('zdteMode').checked;
  var exv=gel('oexp').value,exd=exv?new Date(exv):null,dte=exd?Math.max(1,Math.ceil((exd-new Date())/864e5)):30;
  fill.style.width='20%';
  var liveQ=null;if(!S){var c=await fetchBulk([tk]);liveQ=c?c[tk]:null;if(liveQ&&liveQ.price)S=liveQ.price;}else{liveQ={price:S,chg:0,pct:0};}
  doneStep(0);fill.style.width='40%';
  var premScore=null,sigma=null,G=null,setupGrade=null,rr=null;
  if(isOpt&&S>0&&K>0&&prem>0){var T=dte/365,r=.0428;sigma=calcIV(prem,S,K,T,r,tp);G=gks(S,K,T,r,sigma,tp);premScore=calcPremScore(S,K,tp,dte,G,sigma,prem,zdteMode);}
  else if(!isOpt){var en2=parseFloat(gel('se-in').value)||S,tg2=parseFloat(gel('st-in').value)||0,sl2=parseFloat(gel('sl-in').value)||0;if(en2>0&&tg2>0&&sl2>0){rr=(tg2-en2)/(en2-sl2);setupGrade=rr>=3?'A':rr>=2?'B+':rr>=1.5?'C':rr>=1?'D':'F';}}
  doneStep(1);fill.style.width='55%';
  var otmPct=0,otmLabel='';if(isOpt&&S>0&&K>0){otmPct=tp==='call'?(K-S)/S:(S-K)/S;otmLabel=otmPct>0?((otmPct*100).toFixed(1)+'% OTM'):'ITM';}
  var tradeInfo=isOpt?'OPTION MATH: '+tp.toUpperCase()+' Strike=$'+K+' Stock=$'+(S?S.toFixed(2):'?')+' '+otmLabel+' DTE='+dte+(zdteMode?' (0DTE mode)':'')+' Premium=$'+prem+' IV='+(sigma?(sigma*100).toFixed(1)+'%':'?')+' Delta='+(G?G.delta.toFixed(3):'?')+' ProbProfit='+(G?Math.round(Math.abs(G.delta)*100)+'%':'?')+' LocalScore='+(premScore||'?')+'/100':'STOCK SETUP: Entry=$'+(gel('se-in').value||'?')+' Target=$'+(gel('st-in').value||'?')+' Stop=$'+(gel('sl-in').value||'?')+' RR='+(rr?rr.toFixed(2):'?')+'x Grade='+(setupGrade||'?');
  var rules='VERDICT: Under 30=AVOID Near-Certain Loss. 30-44=AVOID Poor Setup. 45-67=REVIEW Moderate. 68-80=EXECUTE High Conviction. Above 80=deep ITM only. Score based on trade math not company sentiment.';
  var prompt='You are a strict Goldman Sachs risk manager. Search for current info on '+tk+'. Honest verdict on this trade. '+tradeInfo+'. '+rules+'. Return ONLY valid JSON no markdown: {"company":"Name","price":'+(S||0)+',"change":'+(liveQ?liveQ.chg:0)+',"pct":'+(liveQ?liveQ.pct:0)+',"sentiment":{"score":65,"direction":"Bullish","bull":60,"neut":28,"bear":12},"bbConsensus":{"buy":3,"neutral":1,"sell":1,"avgPT":200,"upside":10},"thesis":"3-sentence honest assessment of this trade setup specifically.","catalysts":["catalyst 1","catalyst 2","catalyst 3"],"risks":["risk 1","risk 2"],"earningsDays":45,"macroFit":"Brief macro context","verdict":{"score":25,"label":"Poor Setup","action":"AVOID","color":"red"}}';
  doneStep(2);var txt=await callAI(prompt,true,1800);var aiData=parseJSON(txt);
  doneStep(3);fill.style.width='85%';doneStep(4);fill.style.width='100%';
  setTimeout(function(){stepsCard.remove();prog.remove();renderReport(tk,S,liveQ,isOpt,premScore,sigma,G,dte,tp,K,prem,setupGrade,rr,aiData,body);},400);
}
function renderReport(tk,S,liveQ,isOpt,premScore,sigma,G,dte,tp,K,prem,setupGrade,rr,ai,body){
  body.innerHTML='';
  var pct=liveQ?liveQ.pct:0;
  var vs=ai&&ai.verdict?ai.verdict.score:premScore||50;
  var vl=ai&&ai.verdict?ai.verdict.label:scoreLabel(vs);
  var va=ai&&ai.verdict?ai.verdict.action:vs>=68?'EXECUTE':vs>=45?'REVIEW':'AVOID';
  var vc=vs>=68?'#00c853':vs>=45?'#f5c842':'#ff3d57';
  var circ=263.9,offset=(circ-circ*vs/100).toFixed(1);
  var vCard=document.createElement('div');
  vCard.style.cssText='background:linear-gradient(135deg,'+vc+'18,'+vc+'08);border:1px solid '+vc+'40;border-radius:14px;padding:22px;margin-bottom:11px;text-align:center';
  vCard.innerHTML='<div style="font-size:11px;font-weight:700;color:'+vc+';text-transform:uppercase;letter-spacing:1px;margin-bottom:14px">Pre-Trade Report - '+tk+'</div><div class="verdict-ring"><svg viewBox="0 0 100 100" width="110" height="110"><circle cx="50" cy="50" r="42" stroke="rgba(255,255,255,.08)" stroke-width="9" fill="none"/><circle cx="50" cy="50" r="42" stroke="'+vc+'" stroke-width="9" fill="none" stroke-dasharray="'+circ+'" stroke-dashoffset="'+offset+'" stroke-linecap="round"/></svg><div class="verdict-num" style="color:'+vc+'">'+vs+'</div></div><div style="font-size:13px;font-weight:700;color:'+vc+'">'+vl.toUpperCase()+'</div><div style="font-size:22px;font-weight:900;color:'+vc+';margin-top:8px">'+va+'</div><div style="font-size:12px;color:var(--t3);margin-top:10px">$'+(S?S.toFixed(2):'--')+' <span class="'+(pct>=0?'up':'dn')+'">'+(pct>=0?'+':'')+pct.toFixed(2)+'%</span>'+(ai&&ai.company?' - '+ai.company:'')+'</div>';
  body.appendChild(vCard);
  var sent=ai&&ai.sentiment?ai.sentiment:{score:60,direction:'Neutral',bull:50,neut:30,bear:20};
  var sGrid=document.createElement('div');sGrid.className='m2';
  var g1=isOpt&&premScore!==null?'<div class="mb"><div class="ml">Premium Score</div><div class="mv" style="color:'+(premScore>=68?'var(--g)':premScore>=45?'var(--go)':'var(--r)')+'">'+premScore+'</div><div class="ms">'+scoreLabel(premScore)+'</div></div>':(setupGrade?'<div class="mb"><div class="ml">Setup Grade</div><div class="mv" style="color:'+(setupGrade==='A'||setupGrade==='B+'?'var(--g)':setupGrade==='C'?'var(--go)':'var(--r)')+'">'+setupGrade+'</div><div class="ms">R:R '+(rr?rr.toFixed(2):'--')+'x</div></div>':'');
  var g2=isOpt&&sigma?'<div class="mb"><div class="ml">Implied Vol</div><div class="mv" style="color:var(--b)">'+(sigma*100).toFixed(1)+'%</div><div class="ms">'+(sigma<.35?'Below avg':sigma<.55?'Above avg':'Elevated')+'</div></div>':'';
  sGrid.innerHTML='<div class="mb"><div class="ml">Sentiment</div><div class="mv" style="color:var(--b)">'+sent.score+'</div><div class="ms">'+sent.direction+'</div></div>'+g1+g2+'<div class="mb"><div class="ml">BB Consensus</div><div class="mv up">'+(ai&&ai.bbConsensus?ai.bbConsensus.buy+' Buy':'--')+'</div><div class="ms">'+(ai&&ai.bbConsensus?'Avg PT $'+ai.bbConsensus.avgPT:'--')+'</div></div><div class="mb"><div class="ml">Earnings</div><div class="mv" style="color:var(--go)">'+(ai&&ai.earningsDays?ai.earningsDays+'d':'--')+'</div><div class="ms">'+(ai&&ai.earningsDays&&ai.earningsDays<21?'IV elevated':'Normal')+'</div></div>';
  body.appendChild(sGrid);
  if(ai&&ai.thesis){var tBox=document.createElement('div');tBox.className='thesis-box';tBox.innerHTML='<div style="display:flex;align-items:center;gap:7px;margin-bottom:10px"><div style="font-size:18px">&#127968;</div><div style="font-size:13px;font-weight:700;color:var(--b)">AI Trade Thesis</div></div><p>'+ai.thesis+'</p>';body.appendChild(tBox);}
  if(ai&&(ai.catalysts||ai.risks)){var crCard=document.createElement('div');crCard.className='card';var html='';if(ai.catalysts&&ai.catalysts.length){html+='<div style="font-size:11px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px">Catalysts</div>';ai.catalysts.forEach(function(c){html+='<div class="flag-item"><div class="flag-dot" style="background:var(--g)"></div><span>'+c+'</span></div>';});}if(ai.risks&&ai.risks.length){html+='<div style="font-size:11px;font-weight:700;color:var(--r);text-transform:uppercase;letter-spacing:.7px;margin:'+(ai.catalysts?'14px':'0')+'px 0 8px">Risk Flags</div>';ai.risks.forEach(function(rx){html+='<div class="flag-item"><div class="flag-dot" style="background:var(--r)"></div><span>'+rx+'</span></div>';});}crCard.innerHTML=html;body.appendChild(crCard);}
  if(ai&&ai.macroFit){var mBox=document.createElement('div');mBox.className='wb';mBox.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--go)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>'+ai.macroFit+'</p>';body.appendChild(mBox);}
  if(isOpt&&G&&sigma){var optCard=document.createElement('div');optCard.className='card';var be=(tp==='call'?K+prem:K-prem).toFixed(2);optCard.innerHTML='<h4>Options Details</h4><div class="gr"><span>Break-Even</span><span style="font-weight:700">$'+be+'</span></div><div class="gr"><span>Delta</span><span style="font-weight:700">'+(G.delta>=0?'+':'')+G.delta.toFixed(3)+'</span></div><div class="gr"><span>Theta/Day</span><span style="font-weight:700;color:var(--r)">-$'+(Math.abs(G.theta)*100*prem).toFixed(2)+'</span></div><div class="gr" style="border:none"><span>DTE</span><span style="font-weight:700">'+dte+'d</span></div>';body.appendChild(optCard);}
  var disc=document.createElement('div');disc.style.cssText='font-size:10px;color:var(--t3);text-align:center;padding:12px 0 8px;line-height:1.6';disc.textContent='For informational purposes only. Not financial advice.';body.appendChild(disc);
  var rbBtn=document.createElement('button');rbBtn.style.cssText='width:100%;padding:16px;background:linear-gradient(135deg,#00c853,#00a844);color:#000;border:none;border-radius:14px;font-size:15px;font-weight:800;font-family:Inter,sans-serif;cursor:pointer;margin-bottom:14px';rbBtn.textContent='Open Robinhood';rbBtn.addEventListener('click',function(){window.open('https://robinhood.com','_blank');});body.appendChild(rbBtn);
}
gel('rpt-back').addEventListener('click',function(){gel('rpt-overlay').classList.remove('open');});

/* EARNINGS EDGE */
async function runEarningsEdge(){
  var tk=gel('tk-in').value.trim().toUpperCase();if(!tk){alert('Enter a ticker first.');return;}
  var S=parseFloat(gel('spx-in').value)||0,sigma=null,K=parseFloat(gel('sk-in').value)||0,prem=parseFloat(gel('pm-in').value)||0;
  var exv=gel('oexp').value,exd=exv?new Date(exv):null,dte=exd?Math.max(1,Math.ceil((exd-new Date())/864e5)):30;
  if(S>0&&K>0&&prem>0)sigma=calcIV(prem,S,K,dte/365,.0428,gel('ot').value);
  var ivInfo=sigma?'CurrentIV: '+(sigma*100).toFixed(1)+'% DTE: '+dte+' Stock: $'+(S||'?'):'Stock: $'+(S||'unknown');
  var wrap=gel('ee-res');wrap.style.display='block';wrap.innerHTML='<div class="card"><span class="spin"></span> Loading earnings data for '+tk+'...</div>';wrap.scrollIntoView({behavior:'smooth',block:'start'});
  var prompt='Search for historical earnings data and upcoming earnings for '+tk+'. Return ONLY valid JSON no markdown: {"ticker":"'+tk+'","company":"Company Name","earningsDate":"Mar 15 2025","daysToEarnings":22,"pricedInMovePct":4.2,"avgActualMovePct":3.1,"edgePct":-1.1,"ivCrushScore":72,"recommendation":"Fade","recColor":"green","thesis":"One sentence on whether to play or fade earnings vol.","historicalMoves":[{"quarter":"Q4 2024","movePct":3.2,"direction":"up"},{"quarter":"Q3 2024","movePct":2.8,"direction":"down"},{"quarter":"Q2 2024","movePct":4.1,"direction":"up"},{"quarter":"Q1 2024","movePct":1.9,"direction":"up"}],"bestStrategy":"Strategy recommendation","worstCase":"Worst case scenario"}. Use '+ivInfo+' to estimate pricedInMovePct.';
  var txt=await callAI(prompt,true,1400);var d=parseJSON(txt);
  if(!d){wrap.innerHTML='<div class="card" style="color:var(--r);text-align:center">Could not load earnings data</div>';return;}
  var rec=d.recommendation||'--';
  var recCol=(d.recColor==='green'||rec==='Fade')?'var(--g)':(d.recColor==='red'||rec==='Play')?'var(--b)':'var(--go)';
  var edge=typeof d.edgePct==='number'?d.edgePct:0;
  var ivcs=d.ivCrushScore||50;
  var html='<div class="card" style="margin-bottom:9px"><span class="ai-est">AI-Estimated Data</span>';
  html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px"><div><div style="font-size:16px;font-weight:800">Earnings Edge - '+(d.ticker||tk)+'</div><div style="font-size:11px;color:var(--t3);margin-top:2px">'+(d.company||'')+(d.earningsDate?' - '+d.earningsDate:'')+'</div></div><div style="background:'+recCol+'22;color:'+recCol+';padding:6px 12px;border-radius:20px;font-size:12px;font-weight:800">'+rec.toUpperCase()+'</div></div>';
  html+='<div class="m2"><div class="mb"><div class="ml">Priced-In Move</div><div class="mv" style="color:var(--b)">'+(d.pricedInMovePct||'--')+'%</div><div class="ms">What IV implies</div></div><div class="mb"><div class="ml">Avg Actual Move</div><div class="mv" style="color:var(--go)">'+(d.avgActualMovePct||'--')+'%</div><div class="ms">Historical avg</div></div><div class="mb"><div class="ml">Edge</div><div class="mv" style="color:'+(edge<0?'var(--g)':'var(--r)')+'">'+( edge>=0?'+':'')+edge.toFixed(1)+'%</div><div class="ms">'+(edge<0?'IV Overpriced':'IV Underpriced')+'</div></div><div class="mb"><div class="ml">IV Crush Score</div><div class="mv" style="color:var(--p)">'+ivcs+'</div><div class="ms">Crush probability</div></div></div>';
  html+='<div style="font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.7px;margin-bottom:7px">Historical Moves</div>';
  if(d.historicalMoves&&d.historicalMoves.length){d.historicalMoves.forEach(function(h){var mv=typeof h.movePct==='number'?h.movePct.toFixed(1):String(h.movePct||0);var barW=Math.min(100,parseFloat(mv)/10*100);var col2=h.direction==='up'?'var(--g)':'var(--r)';html+='<div style="margin-bottom:7px"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--t3);margin-bottom:3px"><span>'+h.quarter+'</span><span style="color:'+col2+';font-weight:600">'+(h.direction==='up'?'+':'-')+mv+'%</span></div><div class="ee-bar"><div class="ee-fill" style="width:'+barW+'%;background:'+col2+'"></div></div></div>';});}
  html+='<div style="margin-top:11px;padding-top:11px;border-top:1px solid var(--bd)"><div style="font-size:12px;color:var(--b);font-weight:700;margin-bottom:4px">Best Strategy</div><div style="font-size:12px;color:var(--t2)">'+(d.bestStrategy||'--')+'</div>'+(d.thesis?'<div style="font-size:11px;color:var(--t3);margin-top:8px;line-height:1.5">'+d.thesis+'</div>':'')+'</div></div>';
  wrap.innerHTML=html;
}

/* SIGNALS */
gel('stk').addEventListener('input',function(){this.value=this.value.toUpperCase();});
gel('signals-load-btn').addEventListener('click',loadSignals);
gel('stk').addEventListener('keydown',function(e){if(e.key==='Enter')loadSignals();});
var SENT_TABS={'st-ov':'sent-ov','st-news':'sent-news','st-x':'sent-x','st-ana':'sent-ana','st-flow':'sent-flow'};
Object.keys(SENT_TABS).forEach(function(id){gel(id).addEventListener('click',function(){document.querySelectorAll('#screen-sentiment .tab').forEach(function(b){b.classList.remove('active');});this.classList.add('active');Object.keys(SENT_TABS).forEach(function(k){var e=gel(SENT_TABS[k]);if(e)e.style.display=k===id?'block':'none';});if(id==='st-flow'&&sigTicker&&!flowLoaded){loadOptionsFlow(sigTicker);}});});

async function loadSignals(){
  var raw=gel('stk').value.trim();if(!raw)return;
  sigTicker=raw.toUpperCase();flowLoaded=false;
  var st=gel('sst');st.innerHTML='<span class="spin"></span>Loading signals for '+raw+'...';
  var prompt='Search for current real-time information about stock '+raw+'. Return ONLY valid JSON no markdown: {"ticker":"AAPL","company":"Apple Inc.","price":189.30,"change":2.6,"pct":1.4,"score":72,"direction":"Bullish","bull":68,"neut":22,"bear":10,"earningsDays":45,"analystPT":210,"ptUpside":10.9,"headlines":[{"text":"headline text","source":"Reuters","time":"2h ago","sentiment":"bullish"},{"text":"headline","source":"Bloomberg","time":"4h ago","sentiment":"neutral"},{"text":"headline","source":"WSJ","time":"6h ago","sentiment":"bearish"}],"analysts":[{"firm":"Goldman Sachs","rating":"Buy","action":"Upgrade","pt":220,"upside":16.2},{"firm":"Morgan Stanley","rating":"Overweight","action":"Maintain","pt":210,"upside":10.9},{"firm":"JP Morgan","rating":"Neutral","action":"Maintain","pt":185,"upside":-2.3},{"firm":"Bank of America","rating":"Buy","action":"Maintain","pt":225,"upside":18.9},{"firm":"Citigroup","rating":"Neutral","action":"Maintain","pt":180,"upside":-4.9}],"xPosts":[{"name":"The Kobeissi Letter","handle":"@KobeissiLetter","role":"Institutional Macro","initials":"KL","color":"#38c8ff","body":"relevant commentary","sentiment":"bullish","likes":"8.4K","rt":"2.1K"},{"name":"Bill Ackman","handle":"@BillAckman","role":"Pershing Square","initials":"BA","color":"#00c853","body":"relevant commentary","sentiment":"bullish","likes":"14K","rt":"3.8K"},{"name":"Raoul Pal","handle":"@RaoulGMI","role":"Macro Investor GMI","initials":"RP","color":"#f5c842","body":"relevant commentary","sentiment":"neutral","likes":"9.7K","rt":"2.9K"}]}';
  var txt=await callAI(prompt,true,2500);var d=parseJSON(txt);
  if(d){st.innerHTML='<span style="color:var(--g)">Live signals loaded for '+(d.ticker||raw.toUpperCase())+(d.company?' - '+d.company:'')+'</span>';renderSignals(d);}
  else{st.innerHTML='<span style="color:var(--r)">Could not load signals</span>';}
}

function renderSignals(d){
  var tk=d.ticker||'--';
  var ov=gel('sent-ov');ov.innerHTML='';
  var ovCard=document.createElement('div');ovCard.className='card';var sc=d.score||0,dir=(d.direction||'').toUpperCase(),dirPill='pg';if(sc<60)dirPill='pgo';if(sc<40)dirPill='pr';
  ovCard.innerHTML='<h4>Live Sentiment - '+tk+'</h4>';
  var inner=document.createElement('div');inner.style.cssText='display:flex;gap:10px';
  inner.innerHTML='<div style="flex:1;background:var(--gd);border-radius:var(--rs);padding:14px;text-align:center"><div style="font-size:26px;font-weight:800;color:var(--g)">'+sc+'</div><div style="font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-top:2px">Score</div><div class="pill '+dirPill+'" style="margin-top:6px">'+dir+'</div></div><div style="flex:2;display:flex;flex-direction:column;gap:7px;justify-content:center"><div style="display:flex;align-items:center;gap:7px"><div style="flex:1;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:'+(d.bull||0)+'%;height:100%;background:var(--g);border-radius:3px"></div></div><span class="up" style="font-size:11px;font-weight:600;min-width:30px">'+(d.bull||0)+'%</span><span style="font-size:10px;color:var(--t3)">Bull</span></div><div style="display:flex;align-items:center;gap:7px"><div style="flex:1;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:'+(d.neut||0)+'%;height:100%;background:var(--go);border-radius:3px"></div></div><span style="font-size:11px;font-weight:600;color:var(--go);min-width:30px">'+(d.neut||0)+'%</span><span style="font-size:10px;color:var(--t3)">Neut</span></div><div style="display:flex;align-items:center;gap:7px"><div style="flex:1;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="width:'+(d.bear||0)+'%;height:100%;background:var(--r);border-radius:3px"></div></div><span class="dn" style="font-size:11px;font-weight:600;min-width:30px">'+(d.bear||0)+'%</span><span style="font-size:10px;color:var(--t3)">Bear</span></div></div>';
  ovCard.appendChild(inner);
  var m2=document.createElement('div');m2.className='m2';m2.style.marginTop='11px';
  m2.innerHTML='<div class="mb"><div class="ml">News</div><div class="mv '+(sc>=60?'up':'dn')+'">'+(d.direction||'--')+'</div><div class="ms">'+(d.headlines?d.headlines.length:0)+' headlines</div></div><div class="mb"><div class="ml">X/Twitter</div><div class="mv '+(sc>=60?'up':'')+'">'+( d.xPosts&&d.xPosts.length?'Active':'--')+'</div><div class="ms">Pro traders</div></div><div class="mb"><div class="ml">Avg PT</div><div class="mv">$'+(d.analystPT||'--')+'</div><div class="ms '+((d.ptUpside||0)>=0?'up':'dn')+'">'+(( d.ptUpside||0)>=0?'+':'')+(d.ptUpside||0)+'%</div></div><div class="mb"><div class="ml">Earnings</div><div class="mv" style="color:var(--go)">'+(d.earningsDays?d.earningsDays+'d':'--')+'</div><div class="ms">'+((d.earningsDays||99)<21?'IV elevated':'Normal')+'</div></div>';
  ovCard.appendChild(m2);ov.appendChild(ovCard);
  var nw=gel('sent-news');nw.innerHTML='';var nCard=document.createElement('div');nCard.className='card';nCard.innerHTML='<h4>Headlines - '+tk+'</h4>';
  (d.headlines||[]).forEach(function(h){var dc=h.sentiment==='bullish'?'var(--g)':h.sentiment==='bearish'?'var(--r)':'var(--go)';var pc=h.sentiment==='bullish'?'pg':h.sentiment==='bearish'?'pr':'pgo';var item=document.createElement('div');item.className='ni';item.innerHTML='<div class="nd" style="background:'+dc+'"></div><div><div style="font-size:13px;line-height:1.5;color:var(--t2)">'+h.text+'</div><div style="font-size:10px;color:var(--t3);margin-top:3px">'+h.source+' '+h.time+'</div><span class="pill '+pc+'" style="margin-top:4px">'+(h.sentiment||'').toUpperCase()+'</span></div>';nCard.appendChild(item);});
  nw.appendChild(nCard);
  var xw=gel('sent-x');xw.innerHTML='';var xHdr=document.createElement('div');xHdr.style.cssText='background:var(--bg3);border:1px solid var(--bd);border-radius:var(--rs);padding:10px 13px;margin-bottom:13px;font-size:11px;color:var(--t3)';xHdr.textContent='Verified institutional investors and professional traders only';xw.appendChild(xHdr);
  (d.xPosts||[]).forEach(function(x){var sc2=x.sentiment==='bullish'?'pg':x.sentiment==='bearish'?'pr':'pgo';var xp=document.createElement('div');xp.className='xp';xp.innerHTML='<div style="display:flex;align-items:center;gap:9px;margin-bottom:10px"><div class="xa" style="background:'+x.color+'22;color:'+x.color+'">'+x.initials+'</div><div style="flex:1"><div style="display:flex;align-items:center"><span style="font-size:13px;font-weight:700">'+x.name+'</span><div class="xv">v</div></div><div style="font-size:11px;color:var(--t3)">'+x.handle+' - '+x.role+'</div></div><span class="pill '+sc2+'" style="font-size:9px">'+(x.sentiment||'').toUpperCase()+'</span></div><div style="font-size:13px;line-height:1.6;color:var(--t2);margin-bottom:9px">'+x.body+'</div><div style="display:flex;gap:13px"><span style="font-size:11px;color:var(--t3)">'+x.likes+' likes</span><span style="font-size:11px;color:var(--t3)">'+x.rt+' retweets</span></div>';xw.appendChild(xp);});
  var xFoot=document.createElement('div');xFoot.style.cssText='text-align:center;font-size:10px;color:var(--t3);padding:4px 0 8px';xFoot.textContent='For market context only.';xw.appendChild(xFoot);
  var aw=gel('sent-ana');aw.innerHTML='';var aCard=document.createElement('div');aCard.className='card';aCard.innerHTML='<h4>Analyst Ratings - '+tk+'</h4>';
  (d.analysts||[]).forEach(function(a){var up2=a.upside>=0;var rc=(a.rating==='Buy'||a.rating==='Overweight')?'var(--g)':(a.rating==='Sell'||a.rating==='Underweight')?'var(--r)':'var(--go)';var sh=a.firm.indexOf('Goldman')>=0?'GS':a.firm.indexOf('Morgan Stanley')>=0?'MS':a.firm.indexOf('JP')>=0?'JPM':a.firm.indexOf('Bank')>=0?'BAC':a.firm.indexOf('Citi')>=0?'CITI':'UBS';var row=document.createElement('div');row.className='br';row.innerHTML='<div style="display:flex;align-items:center;gap:9px"><div class="bl" style="background:var(--bd3);color:var(--b)">'+sh+'</div><div><div style="font-size:13px;font-weight:700">'+a.firm+'</div><div style="font-size:11px;color:'+rc+'">'+a.action+' - '+a.rating+'</div></div></div><div style="text-align:right"><div style="font-size:17px;font-weight:800;color:'+(up2?'var(--g)':'var(--r)')+'">$'+a.pt+'</div><div style="font-size:11px;color:'+(up2?'var(--g)':'var(--r)')+'">'+(up2?'+':'')+(a.upside||0).toFixed(1)+'%</div></div>';aCard.appendChild(row);});
  aw.appendChild(aCard);
}

/* OPTIONS FLOW */
async function loadOptionsFlow(tk){
  flowLoaded=true;var fw=gel('sent-flow');
  fw.innerHTML='<div class="card" style="text-align:center;padding:18px"><span class="spin"></span> Loading flow for '+tk+'...</div>';
  var prompt='Search for unusual options activity for stock '+tk+'. Return ONLY valid JSON no markdown: {"ticker":"'+tk+'","flowScore":72,"direction":"Bullish","putCallRatio":0.65,"bullFlowPct":68,"bearFlowPct":32,"totalPremium":"$4.2M","unusualPrints":[{"type":"Call Sweep","strike":200,"expiry":"Mar 21","contracts":5000,"premium":"$1.2M","sentiment":"bullish","note":"Aggressive buyer paid ask"},{"type":"Put Sweep","strike":185,"expiry":"Feb 28","contracts":3000,"premium":"$480K","sentiment":"bearish","note":"Protective puts near support"},{"type":"Call Block","strike":210,"expiry":"Apr 18","contracts":8000,"premium":"$2.1M","sentiment":"bullish","note":"Large institutional block"}],"darkPoolScore":64,"summary":"Summary of unusual activity","whaleNote":"Institutional signal note"}';
  var txt=await callAI(prompt,true,1500);var d=parseJSON(txt);
  if(!d){fw.innerHTML='<div class="card" style="color:var(--r);text-align:center;padding:18px">Could not load flow data</div>';return;}
  var col=d.direction==='Bullish'?'var(--g)':d.direction==='Bearish'?'var(--r)':'var(--go)';
  var pcr=parseFloat(d.putCallRatio)||1;
  var pcrLabel=pcr<0.8?'Bullish':pcr>1.2?'Bearish':'Neutral';
  fw.innerHTML='';
  var scoreCard=document.createElement('div');scoreCard.className='card';
  scoreCard.innerHTML='<span class="ai-est">AI-Estimated Data</span><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:13px"><div><div style="font-size:16px;font-weight:800">Options Flow - '+(d.ticker||'--')+'</div><div style="font-size:11px;color:var(--t3);margin-top:2px">'+(d.summary||'')+'</div></div><div style="background:'+col+'22;color:'+col+';padding:6px 12px;border-radius:20px;font-size:12px;font-weight:800">'+(d.direction||'--')+'</div></div><div class="m2"><div class="mb"><div class="ml">Flow Score</div><div class="mv" style="color:'+col+'">'+(d.flowScore||'--')+'</div><div class="ms">Smart money signal</div></div><div class="mb"><div class="ml">Put/Call Ratio</div><div class="mv" style="color:'+(pcr<0.8?'var(--g)':pcr>1.2?'var(--r)':'var(--go)')+'">'+(d.putCallRatio||'--')+'</div><div class="ms">'+pcrLabel+'</div></div><div class="mb"><div class="ml">Total Premium</div><div class="mv" style="font-size:14px">'+(d.totalPremium||'--')+'</div><div class="ms">Options volume</div></div><div class="mb"><div class="ml">Dark Pool</div><div class="mv" style="color:var(--p)">'+(d.darkPoolScore||'--')+'</div><div class="ms">Institutional score</div></div></div><div style="display:flex;height:8px;border-radius:4px;overflow:hidden;gap:2px"><div style="flex:'+(d.bullFlowPct||50)+';background:var(--g)"></div><div style="flex:'+(d.bearFlowPct||50)+';background:var(--r)"></div></div><div style="display:flex;justify-content:space-between;margin-top:5px;font-size:10px;color:var(--t3)"><span class="up">'+(d.bullFlowPct||50)+'% Bull</span><span class="dn">'+(d.bearFlowPct||50)+'% Bear</span></div>';
  fw.appendChild(scoreCard);
  if(d.whaleNote){var wn=document.createElement('div');wn.className='wb';wn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--go)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>'+d.whaleNote+'</p>';fw.appendChild(wn);}
  if(d.unusualPrints&&d.unusualPrints.length){var hdr=document.createElement('p');hdr.className='sec';hdr.textContent='Unusual Prints';fw.appendChild(hdr);d.unusualPrints.forEach(function(up3){var isBull=up3.sentiment==='bullish';var pc2=isBull?'var(--g)':'var(--r)';var bg2=isBull?'var(--gd)':'var(--rd)';var el=document.createElement('div');el.className='flow-print';el.innerHTML='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px"><div style="display:flex;align-items:center;gap:7px"><div class="flow-badge" style="background:'+bg2+';color:'+pc2+'">'+(up3.type||'--')+'</div><div style="font-size:13px;font-weight:700">$'+(up3.strike||'--')+' '+(up3.expiry||'--')+'</div></div><div style="font-size:14px;font-weight:800;color:'+pc2+'">'+(up3.premium||'--')+'</div></div><div style="font-size:11px;color:var(--t3)">'+(up3.contracts||'--')+' contracts - '+(up3.note||'')+'</div>';fw.appendChild(el);});}
}

/* MEDIA */
function openURL(url){window.open(url,'_blank');}
[['bb-open','https://www.bloomberg.com/live-tv'],['bb-btn','https://www.bloomberg.com/live-tv'],['cnbc-open','https://www.cnbc.com/live-tv/'],['cnbc-btn','https://www.cnbc.com/live-tv/'],['yf-open','https://finance.yahoo.com/live/'],['yf-btn','https://finance.yahoo.com/live/'],['mw-btn','https://www.marketwatch.com'],['sa-btn','https://seekingalpha.com'],['uw-btn','https://unusualwhales.com'],['bz-btn','https://www.benzinga.com'],['fv-btn','https://finviz.com'],['ba-btn','https://www.barrons.com'],['tv-btn','https://www.tradingview.com'],['os-btn','https://optionstrat.com'],['cb-btn','https://www.cboe.com'],['fred-btn','https://fred.stlouisfed.org'],['sec-btn','https://www.sec.gov/cgi-bin/browse-edgar'],['yo-btn','https://finance.yahoo.com/options']].forEach(function(pair){var e=gel(pair[0]);if(e)e.addEventListener('click',(function(url){return function(){openURL(url);};})(pair[1]));});
['mt-live','mt-charts','mt-news','mt-tools'].forEach(function(id){gel(id).addEventListener('click',function(){document.querySelectorAll('#screen-media .tab').forEach(function(b){b.classList.remove('active');});this.classList.add('active');var map={'mt-live':'m-live','mt-charts':'m-charts','mt-news':'m-news','mt-tools':'m-tools'};Object.keys(map).forEach(function(k){var e=gel(map[k]);if(e)e.style.display=k===id?'block':'none';});});});

/* JOURNAL */
gel('open-at-btn').addEventListener('click',openAT);gel('log-first-btn').addEventListener('click',openAT);gel('jt-save-btn').addEventListener('click',saveJTrade);gel('jt-cancel-btn').addEventListener('click',function(){gel('atm').classList.add('hidden');});gel('jt-opt-btn').addEventListener('click',function(){setJtType('option',this);});gel('jt-stk-btn').addEventListener('click',function(){setJtType('stock',this);});gel('ai-recs-btn').addEventListener('click',getAIRecs);gel('clear-j-btn').addEventListener('click',function(){if(confirm('Clear all journal trades?')){journal=[];sv('sfx_journal',[]);renderJournal();}});gel('jt-tk').addEventListener('input',function(){this.value=this.value.toUpperCase();});
function openAT(){gel('atm').classList.remove('hidden');gel('jt-date').value=new Date().toISOString().split('T')[0];}
function setJtType(tp,btn){jtType=tp;document.querySelectorAll('#jt-seg .sb').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');gel('jt-of').style.display=tp==='option'?'block':'none';gel('jt-sf').style.display=tp==='stock'?'block':'none';}
function saveJTrade(){var tk=(gel('jt-tk').value||'').trim().toUpperCase();if(!tk)return;var dir=gel('jt-dir').value,date=gel('jt-date').value,en,ex,qty,pnl,ret,be;if(jtType==='option'){en=parseFloat(gel('jt-en').value)||0;ex=parseFloat(gel('jt-ex').value)||0;qty=parseInt(gel('jt-qty').value)||1;var str=parseFloat(gel('jt-str').value)||0;pnl=(ex-en)*100*qty;ret=en>0?(ex-en)/en*100:0;be=dir==='Call'?str+en:str-en;}else{en=parseFloat(gel('jts-en').value)||0;ex=parseFloat(gel('jts-ex').value)||0;qty=parseInt(gel('jts-qty').value)||0;pnl=(ex-en)*qty;ret=en>0?(ex-en)/en*100:0;be=en;}journal.push({id:Date.now(),date:date,ticker:tk,direction:dir,assetClass:jtType,entry:en,exit:ex,qty:qty,pnl:parseFloat(pnl.toFixed(2)),retPct:parseFloat(ret.toFixed(2)),breakeven:parseFloat(be.toFixed(2)),notes:gel('jt-notes').value.trim(),status:ex>0?'closed':'open'});sv('sfx_journal',journal);renderJournal();gel('atm').classList.add('hidden');['jt-tk','jt-en','jt-ex','jt-str','jts-en','jts-ex','jts-qty','jt-notes'].forEach(function(id){var e=gel(id);if(e)e.value='';});gel('jt-qty').value='1';}
function renderJournal(){var has=journal.length>0;gel('j-empty').style.display=has?'none':'block';gel('j-stats').style.display=has?'grid':'none';gel('jchart').style.display=has?'block':'none';gel('jai-wrap').style.display=has?'block':'none';gel('j-tt').style.display=has?'block':'none';gel('j-trades').innerHTML='';if(!has)return;var closed=journal.filter(function(t){return t.status==='closed';});var wr=closed.length?Math.round(closed.filter(function(t){return t.pnl>0;}).length/closed.length*100):0;var tot=journal.reduce(function(s,t){return s+t.pnl;},0);var jwrE=gel('jwr');if(jwrE){jwrE.textContent=wr+'%';jwrE.className=wr>=50?'up':'dn';}var jpE=gel('jpnl');if(jpE){jpE.textContent=(tot>=0?'+$':'-$')+Math.abs(tot).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});jpE.className=tot>=0?'up':'dn';}setText('jcnt',journal.length);drawChart(journal,tot);var frag=document.createDocumentFragment();journal.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date);}).forEach(function(t){var up2=t.pnl>=0,pc=t.assetClass==='option'?(t.direction==='Call'?'pb':'pr'):(t.direction==='Long'?'pg':'pr');var el=document.createElement('div');el.className='ti';el.innerHTML='<div style="display:flex;justify-content:space-between;margin-bottom:10px"><div><div style="font-size:16px;font-weight:800">'+t.ticker+' <span class="pill '+pc+'">'+t.direction+'</span></div><div style="font-size:10px;color:var(--t3);margin-top:2px">'+(t.assetClass==='option'?'BE $'+t.breakeven+' - ':'')+t.date+'</div></div><div style="text-align:right"><div class="'+(up2?'up':'dn')+'" style="font-size:18px;font-weight:800">'+(up2?'+$':'-$')+Math.abs(t.pnl).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+'</div><div style="font-size:10px;color:var(--t3);margin-top:2px">'+t.status+'</div></div></div><div class="tst"><div class="tsi">Entry<span>$'+t.entry+'</span></div><div class="tsi">Exit<span>'+(t.exit?'$'+t.exit:'Open')+'</span></div><div class="tsi">Qty<span>'+t.qty+'</span></div><div class="tsi">Return<span class="'+(up2?'up':'dn')+'">'+(up2?'+':'')+t.retPct.toFixed(1)+'%</span></div></div>'+(t.notes?'<div style="font-size:11px;color:var(--t3);margin-top:8px;padding-top:8px;border-top:1px solid var(--bd)">'+t.notes+'</div>':'');frag.appendChild(el);});gel('j-trades').appendChild(frag);}
function drawChart(trades,tot){var svg=gel('jsvg');if(!svg)return;var jcv=gel('jcv');if(jcv){jcv.textContent=(tot>=0?'+$':'-$')+Math.abs(tot).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});jcv.className=tot>=0?'up':'dn';}var sorted=trades.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date);}),cum=0;var pts=[0].concat(sorted.map(function(t){cum+=t.pnl;return cum;}));var mn=Math.min.apply(null,pts),mx=Math.max.apply(null,pts),rng=mx-mn||1;var px=function(i){return i/(pts.length-1||1)*360+20;},py=function(v){return 170-20-(v-mn)/rng*130;};var poly=pts.map(function(v,i){return px(i)+','+py(v);}).join(' '),col=tot>=0?'#00c853':'#ff3d57';svg.innerHTML='<defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+col+'" stop-opacity=".28"/><stop offset="100%" stop-color="'+col+'" stop-opacity="0"/></linearGradient></defs><polyline points="'+poly+'" stroke="'+col+'" stroke-width="2" fill="none"/><polygon points="'+poly+' '+px(pts.length-1)+',170 '+px(0)+',170" fill="url(#cg)"/>';}
async function getAIRecs(){if(journal.length<2){alert('Log at least 2 trades first.');return;}var btn=gel('ai-recs-btn');if(btn){btn.disabled=true;btn.innerHTML='<span class="spin"></span>Analyzing...';}var closed=journal.filter(function(t){return t.status==='closed';});var wr=closed.length?Math.round(closed.filter(function(t){return t.pnl>0;}).length/closed.length*100):0;var summary={trades:journal.length,winRate:wr,totalPnl:journal.reduce(function(s,t){return s+t.pnl;},0),recentTrades:closed.slice(-10).map(function(t){return{ticker:t.ticker,direction:t.direction,pnl:t.pnl,ret:t.retPct};})};var prompt='You are a professional trading coach. Analyze this journal and give specific actionable coaching. Account: $'+(user.accountSize||'unknown')+' Risk: '+(user.riskPct||2)+'% per trade. Journal: '+JSON.stringify(summary)+'. Return ONLY this JSON no markdown: {"summary":"1-sentence assessment","recommendations":[{"title":"action title","detail":"specific advice","priority":"high"},{"title":"title","detail":"advice","priority":"medium"},{"title":"title","detail":"advice","priority":"low"}]}';var raw=await callAI(prompt,false,1000);var d=parseJSON(raw);var pC={high:'var(--r)',medium:'var(--go)',low:'var(--g)'};if(d){gel('jai').innerHTML='<p style="font-size:13px;color:var(--t2);margin-bottom:12px;line-height:1.5">'+(d.summary||'')+'</p>'+(d.recommendations||[]).map(function(r){return'<div class="ai-rec"><div class="art" style="color:'+(pC[r.priority]||'var(--b)')+'">'+r.title+' <span style="font-size:9px;opacity:.7;text-transform:uppercase;letter-spacing:.5px">'+r.priority+'</span></div><div class="ard">'+r.detail+'</div></div>';}).join('')+'<button class="abtn" style="background:var(--b);font-size:12px;padding:10px;margin-top:10px" id="ai-refresh-btn">Refresh</button>';var rb=gel('ai-refresh-btn');if(rb)rb.addEventListener('click',getAIRecs);}else{gel('jai').innerHTML='<p style="color:var(--r);font-size:13px">Could not generate analysis.</p><button class="abtn" style="background:var(--b);font-size:13px;padding:11px;margin-top:8px" id="ai-retry-btn">Retry</button>';var rt=gel('ai-retry-btn');if(rt)rt.addEventListener('click',getAIRecs);}}

/* INIT */
(function(){
  var u=ld('sfx_user',null);if(u&&u.name)user=u;
  applyUser();
  var t=ld('sfx_theme','dark');applyTheme(t);highlightThBtn(t);
  journal=ld('sfx_journal',[]);
  watchlist=ld('sfx_watchlist',['AAPL','PLTR','NVDA','SPY']);
  renderWatchlist(null);renderJournal();populateExpiries();loadPrices();loadFearAndGreed();
  setInterval(loadPrices,90000);setInterval(loadFearAndGreed,300000);
})();
})();
</script>
</body>
</html>
